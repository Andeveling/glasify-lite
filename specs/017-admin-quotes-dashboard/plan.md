# Implementation Plan: Admin Quotes Dashboard with Status Differentiation

**Branch**: `001-admin-quotes-dashboard` | **Date**: 2025-11-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-admin-quotes-dashboard/spec.md`

**Note**: This plan was generated by `/speckit.plan` following the Speckit methodology.

## Summary

Refactor the existing quotes dashboard from `/dashboard/quotes` to `/admin/quotes` within the admin module, providing administrators with comprehensive visibility of all system quotes (not filtered by user). The dashboard will feature clear visual differentiation of quote states (draft/sent/canceled) through color-coded badges, advanced filtering by status and user, expanded search capabilities (project name + user name), and detailed contact information in quote views. The implementation focuses on UI/UX improvements following the established admin module layout pattern (Header → Filters → List → Pagination) while leveraging existing tRPC procedures and database schema.

## Technical Context

**Language/Version**: TypeScript 5.9.3 (strict mode), Node.js ES2022  
**Primary Dependencies**: Next.js 16.0.1 (App Router), React 19.2.0, tRPC 11.6.0, Zod 4.1.12  
**Storage**: PostgreSQL (existing schema - Quote, User, QuoteStatus enum)  
**Testing**: Vitest 4.0.4 (unit/integration with jsdom), Playwright 1.56.0 (E2E)  
**Target Platform**: Web application (SSR with Next.js App Router)  
**Project Type**: Web application (Next.js monorepo structure)  
**Performance Goals**: 
- Dashboard initial load < 2 seconds
- Filter/search response < 500ms
- Support 1000+ quotes with server-side pagination
**Constraints**: 
- Admin-only access (role="admin")
- Must use existing tRPC `quote.list-all` procedure
- No database schema changes
- Spanish UI, English code/comments
**Scale/Scope**: 
- 8 user stories (6 list view + 1 detail view + 1 search)
- ~15-20 components (mix of new + refactored)
- Affects 2 routes: /admin/quotes (list), /admin/quotes/[quoteId] (detail)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: `.specify/memory/constitution.md` - verify feature complies with all principles.

### Core Values Compliance

- [x] **Clarity Over Complexity**: Design uses clear, descriptive names and simple logic
  - Component names descriptive: `QuoteStatusBadge`, `QuoteRoleBadge`, `UserContactInfo`
  - Search logic straightforward: filter by project OR user name
  - No complex state management - URL params + Server Components
  
- [x] **Server-First Performance**: Heavy work done on server, appropriate caching strategy defined
  - [x] Caching strategy documented:
    - **Admin routes**: `dynamic = 'force-dynamic'` (no ISR) - always fresh data for admins
    - **tRPC queries**: Default staleTime from React Query config
    - **Search/filters**: Server-side via tRPC `quote.list-all` (no client-side filtering)
  - [x] SSR mutations use two-step invalidation: `invalidate()` + `router.refresh()`
    - Pattern already established in project (see AGENTS.md)
    - Will be applied to any quote update mutations if added
  
- [x] **One Job, One Place (SOLID Architecture)**: Modular architecture with clear separation
  - [x] Forms follow mandatory file organization: N/A (no forms in this feature, read-only dashboard)
  - [x] No SOLID violations:
    - Components < 100 lines UI-only ✓
    - No mutations in this feature (read-only) ✓
    - No schemas needed (using existing tRPC schemas) ✓
    - Constants extracted (badge colors, status labels) ✓
  - [x] Magic numbers extracted to constants file
    - Badge colors defined in constants
    - Pagination limits in constants
    - Status labels (Borrador, Enviada, Cancelada) in constants
  - [x] Default values in utils: N/A (no forms)
  - [x] Business logic separated from UI rendering
    - Server Components fetch data
    - Client Components handle UI interactions only
    - No business logic in components
  
- [x] **Flexible Testing**: Testing strategy defined
  - **Unit tests**: Badge components, utility functions (status labels, formatters)
  - **Integration tests**: Server Components with mocked tRPC
  - **E2E tests**: Critical paths - filter by status, search, pagination, navigate to detail
  - **Tests before merge**: Required for all user stories
  
- [x] **Extend, Don't Modify**: New features add code, don't change existing working code
  - Creates new route `/admin/quotes` (doesn't modify existing routes)
  - Adds new badge components (doesn't modify existing UI kit)
  - Extends search to include user name (backward compatible with project-only search)
  - Deprecates `/dashboard/quotes` cleanly with redirect
  
- [x] **Security From the Start**: Input validation and authorization checks at every entry point
  - [x] User permissions checked server-side:
    - Middleware: `/admin/*` routes protected (admin-only)
    - tRPC: `quote.list-all` uses `sellerOrAdminProcedure` (existing)
    - Server Component: Session check before rendering
  - [x] All user input validated with Zod schemas
    - Search params validated (status enum, page number, search string)
    - Existing tRPC schemas used (`listAllQuotesInput`)
  
- [x] **Track Everything Important**: Logging strategy defined
  - [x] Winston logger used ONLY in server-side code
    - No logging in Client Components ✓
    - Server-side logging in tRPC procedures (already implemented)
  - [x] Error messages to users in Spanish, technical logs in English
    - UI errors: "No se encontraron cotizaciones", "Error al cargar cotizaciones"
    - Server logs: "Failed to fetch quotes", "User unauthorized"

### Language & Communication

- [x] Code/comments/commits in English only
- [x] UI text in Spanish (es-LA) only
  - "Todas las Cotizaciones", "Borrador", "Enviada", "Cancelada"
  - "Buscar por proyecto o usuario", "Información del Creador"
- [x] Commit messages follow Conventional Commits format
  - `feat: refactor quotes dashboard to admin module`
  - `feat: add quote status and role badges`
  - `feat: add user contact info to quote detail`

### Technology Constraints

- [x] Uses required stack: Next.js 16 (App Router) ✓, TypeScript (strict) ✓, React 19 ✓, tRPC ✓, Prisma ✓, PostgreSQL ✓
- [x] No prohibited technologies (Vue/Angular/Svelte, non-TailwindCSS frameworks, Winston in browser) ✓
- [x] UI components use Shadcn/ui + Radix UI + TailwindCSS ✓
  - Will use existing Badge, Card, Table components
  - Custom badges follow Shadcn/ui patterns

### Quality Gates

- [x] TypeScript strict mode enabled, no type errors expected
- [x] Biome/Ultracite formatting rules followed
- [x] Tests planned for all user journeys
  - US1-US8: E2E tests for filters, search, pagination, detail view
  - Unit tests for badge components and utilities
- [x] Changelog entry planned for user-facing changes
  - Entry: "Admin Quotes Dashboard refactored to /admin/quotes with enhanced filtering and visual differentiation"
- [x] Migration notes prepared
  - Redirect from `/dashboard/quotes` to `/admin/quotes`
  - No breaking changes (feature enhancement)

### Principle Priority Resolution

No conflicts identified. Feature aligns with all constitution principles without requiring trade-offs.

**Result**: ✅ PASS

## Project Structure

### Documentation (this feature)

```text
specs/001-admin-quotes-dashboard/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0: Technical research (to be generated)
├── data-model.md        # Phase 1: Data model documentation (to be generated)
├── quickstart.md        # Phase 1: Developer quickstart guide (to be generated)
├── contracts/           # Phase 1: API contracts (to be generated)
│   └── quote-list.contract.md
├── tasks.md             # Phase 2: Task breakdown (generated by /speckit.tasks)
└── checklists/
    └── requirements.md  # Spec quality checklist (complete)
```

### Source Code (repository root)

```text
src/app/(dashboard)/admin/quotes/
├── _components/
│   ├── quote-list-item.tsx          # Quote card/row component (refactor from /quotes)
│   ├── quote-filters.tsx            # Status filter tabs (refactor from /quotes)
│   ├── quote-search.tsx             # Search input (project + user name)
│   ├── quote-sort-controls.tsx      # Sort dropdown/buttons (NEW)
│   ├── quote-status-badge.tsx       # Status badge component (NEW)
│   ├── quote-role-badge.tsx         # User role badge component (NEW)
│   ├── quote-expiration-badge.tsx   # Expiration indicator (NEW)
│   ├── empty-quotes-state.tsx       # Empty state component (refactor from /quotes)
│   └── quotes-pagination.tsx        # Pagination controls (refactor from /quotes)
├── _constants/
│   ├── quote-status.constants.ts    # Status labels, colors, icons (NEW)
│   └── quote-filters.constants.ts   # Filter options, limits (NEW)
├── _types/
│   └── quote-list.types.ts          # TypeScript types for list view (NEW)
├── [quoteId]/
│   ├── _components/
│   │   ├── quote-detail-view.tsx    # Full quote view (refactor from /quotes/[id])
│   │   └── user-contact-info.tsx    # User contact section (NEW)
│   └── page.tsx                     # Quote detail Server Component (refactor)
├── page.tsx                         # Quotes list Server Component (refactor)
└── layout.tsx                       # Shared layout with /admin/* (use existing)

src/app/(dashboard)/quotes/
└── page.tsx                         # DEPRECATED: Redirect to /admin/quotes

src/server/api/routers/quote/
└── quote.ts                         # Existing tRPC router (NO CHANGES)

tests/
├── unit/
│   └── admin/quotes/
│       ├── quote-status-badge.test.ts
│       ├── quote-role-badge.test.ts
│       └── quote-filters.test.ts
└── e2e/
    └── admin-quotes-dashboard.spec.ts
```

**Structure Decision**: Single Next.js App Router web application. Feature uses route group `(dashboard)/admin/quotes` to integrate with existing admin module while maintaining clean URLs (`/admin/quotes`). Components follow established patterns from `/admin/models` and other admin routes. No backend changes required - uses existing tRPC procedures.

## Complexity Tracking

> **No violations requiring justification**

This feature fully complies with all constitution principles without requiring exceptions or trade-offs.
