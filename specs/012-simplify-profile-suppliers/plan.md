````markdown
# Implementation Plan: Simplify Profile Suppliers with SOLID Pattern

**Branch**: `012-simplify-profile-suppliers` | **Date**: 2025-01-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-simplify-profile-suppliers/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following `.specify/templates/commands/plan.md` workflow.

## Summary

Refactor profile suppliers CRUD to use dialog modal pattern (like Services module) instead of separate pages, following SOLID principles with custom hooks for form state and mutations. Extract 247-line monolithic component into <200-line dialog + two custom hooks (<100 lines each). Implement SSR cache invalidation pattern (invalidate + router.refresh) for immediate UI updates after mutations.

## Technical Context

**Language/Version**: TypeScript 5.8.2 (strict mode), Node.js (ES2022 target)  
**Primary Dependencies**: Next.js 15.2.3 (App Router), React 19.0.0 (Server Components), tRPC 11.0.0, TanStack Query 5.69.0, React Hook Form 7.63.0, Zod 4.1.1  
**Storage**: PostgreSQL via Prisma 6.16.2 (existing ProfileSupplier schema)  
**Testing**: Vitest 3.2.4 (unit/integration), Playwright 1.55.1 (E2E)  
**Target Platform**: Web (SSR with force-dynamic for admin routes)
**Project Type**: Web application (Next.js 15 App Router)  
**Performance Goals**: <20s create/edit operations (down from 45s/30s with page navigation), immediate UI updates after mutations (0 perceptible delay)  
**Constraints**: Component <200 lines, hooks <100 lines each, Spanish UI text (es-LA), English code/comments  
**Scale/Scope**: Admin module (RBAC admin-only), ~4 form fields, standard CRUD operations, consistent with Services module pattern

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

This feature must align with Glasify Lite Constitution v2.1.1 principles:

### Single Responsibility (SRP)
- [x] Each component/module has ONE clear responsibility
  - UI component handles only UI composition
  - Form hook handles only form state management  
  - Mutations hook handles only API calls and cache management
- [x] Business logic is separated from UI and data access
  - Form validation in hook, mutations in hook, UI in component
- [x] Tests and docs exist for each public abstraction
  - Architecture README planned, unit tests for hooks

### Open/Closed (OCP)
- [x] New features use extension patterns (hooks, procedures, adapters)
  - Custom hooks are extension pattern, dialog modal is composition
- [x] No modification of stable modules unless documented with migration plan
  - Only refactoring profile-suppliers module, no changes to other modules
- [x] Breaking API changes include MAJOR version bump + migration guide
  - No API changes, using existing tRPC procedures

### Pragmatic Testing Discipline
- [x] Tests MAY be written before/during/after implementation
  - Plan includes E2E tests for critical user flows
- [x] Tests MUST cover happy paths and critical edge cases before merge
  - Spec includes 6 edge cases, all will be tested
- [x] Unit tests run in CI
  - Existing CI setup covers Vitest unit tests
- [x] Integration/contract tests for cross-service changes
  - No cross-service changes, only internal refactoring

### Server-First Architecture (Next.js 15)
- [x] Pages are Server Components by default (`page.tsx`)
  - page.tsx remains Server Component with SSR data fetching
- [x] Client Components (`'use client'`) ONLY for: React hooks, browser APIs, event handlers, client-required libraries
  - Dialog and hooks are Client Components (need React hooks)
- [x] Public pages export `metadata` for SEO
  - N/A - admin route, not public
- [x] Dynamic rendering uses `export const dynamic = 'force-dynamic'`
  - Existing page.tsx already uses force-dynamic
- [x] Pattern: Server Page + Client Content (interactivity in `_components/*-content.tsx`)
  - Following exact pattern from Services module

### Integration & Contract Testing
- [x] Contract tests for shared schemas/API contracts
  - Using existing Zod schemas, no changes
- [x] Integration tests for service boundaries (DB, external APIs, client-server)
  - E2E tests will cover client-server boundary
- [x] Contracts are explicit and versioned
  - tRPC procedures are typed contracts

### Observability & Versioning
- [x] Structured logging with correlation IDs
  - Existing logging in tRPC procedures maintained
- [x] **Winston logger ONLY in server-side code** (Server Components, Server Actions, API routes, tRPC, middleware)
  - No Winston usage in new components (client-side)
- [x] **NO Winston in Client Components** (use console, toast, error boundaries)
  - Using toast for user feedback, no Winston
- [x] Semantic versioning: MAJOR.MINOR.PATCH
  - Internal refactoring, no version change needed
- [x] Authorization checks + audit logging for sensitive operations
  - Existing adminProcedure enforces authorization

### Technology Stack Compliance
- [x] Next.js 15 App Router with React Server Components
- [x] TypeScript (strict), Zod 4, tRPC, Prisma
- [x] React Hook Form + @hookform/resolvers
- [x] shadcn/ui + Radix + TailwindCSS
- [x] Biome/Ultracite for formatting/linting
- [x] UI text in Spanish (es-LA); code/comments/commits in English

### Security & Compliance
- [x] All inputs validated server-side (Zod schemas in tRPC `.input()`)
  - Existing validation in tRPC procedures maintained
- [x] No secrets committed (use env variables + @t3-oss/env-nextjs)
  - No new environment variables needed
- [x] Sensitive operations include authorization + audit logging
  - Existing adminProcedure + logging maintained

### Development Workflow
- [x] Conventional commits format
  - Will follow: `refactor(admin): simplify profile-suppliers with SOLID pattern`
- [x] PR descriptions reference affected principles
  - Will reference SRP and Server-First Performance
- [x] CI gates: typecheck, lint, unit tests, E2E tests (if user flows affected)
  - All gates apply, E2E tests will be updated
- [x] Code review: 1 approver (2 for large/risky changes)
  - Standard review process

---

**Notes**:
- All constitutional checks pass
- No exceptions needed
- Re-validated after design decisions

## Project Structure

### Documentation (this feature)

```
specs/012-simplify-profile-suppliers/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (reference implementation analysis)
├── data-model.md        # Phase 1 output (ProfileSupplier entity)
├── quickstart.md        # Phase 1 output (dev setup and testing)
├── contracts/           # Phase 1 output (tRPC procedures, Zod schemas)
│   ├── api.md          # tRPC procedure contracts
│   └── schemas.md      # Zod validation schemas
└── checklists/
    └── requirements.md  # Specification validation (completed)
```

### Source Code (repository root)

```
src/app/(dashboard)/admin/profile-suppliers/
├── page.tsx                                    # Server Component (SSR, no changes)
├── _hooks/                                     # NEW: Custom hooks directory
│   ├── use-profile-supplier-form.ts           # NEW: Form state management hook
│   └── use-profile-supplier-mutations.ts      # NEW: API mutations hook
└── _components/
    ├── profile-supplier-dialog.tsx            # NEW: Dialog modal component
    ├── profile-supplier-list.tsx              # MODIFIED: Update to use dialog
    ├── profile-supplier-form.tsx              # DEPRECATED: Will be removed
    └── README.md                              # NEW: Architecture documentation

# Directories to remove (separate pages pattern):
src/app/(dashboard)/admin/profile-suppliers/new/        # REMOVE
src/app/(dashboard)/admin/profile-suppliers/[id]/       # REMOVE

# Existing files (no changes):
src/server/api/routers/admin/profile-supplier.ts        # tRPC procedures (existing)
src/lib/validations/admin/profile-supplier.schema.ts    # Zod schemas (existing)
prisma/schema.prisma                                    # ProfileSupplier model (existing)

# Tests:
tests/unit/hooks/use-profile-supplier-form.test.ts     # NEW: Form hook unit tests
tests/unit/hooks/use-profile-supplier-mutations.test.ts # NEW: Mutations hook unit tests
e2e/admin/profile-suppliers.spec.ts                     # MODIFIED: Update for dialog pattern
```

**Structure Decision**: 

Following **Web Application (Next.js 15)** pattern with App Router. Profile suppliers uses the same structure as Services module:

- **Server Component** (`page.tsx`): SSR data fetching with `force-dynamic`
- **Custom Hooks** (`_hooks/`): Separated concerns (form state + mutations)
- **Client Components** (`_components/`): UI composition only
- **Dialog Modal Pattern**: Replaces separate page navigation (new/, [id]/)

This maintains consistency with existing Services module pattern and follows Next.js 15 best practices.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

No constitutional violations. All checks pass. This refactoring simplifies the existing implementation by:

- Reducing component complexity (247 → <200 lines)
- Improving separation of concerns (1 monolithic component → 3 focused modules)
- Removing navigation overhead (separate pages → dialog modal)
- Establishing reusable pattern (can be applied to glass-suppliers, other admin modules)

No exceptions or justifications needed.


---

## Phase 0: Research & Analysis

### Research Tasks

Since this is a refactoring following an established pattern (Services module), most technical decisions are already made. Research focuses on documenting the reference implementation and validating applicability.

**Task 1: Analyze Services Module Pattern**
- **Goal**: Document the exact SOLID pattern used in Services module
- **Deliverables**: 
  - Hook signatures and responsibilities
  - Component composition pattern
  - SSR cache invalidation implementation
  - File structure and naming conventions
- **Status**: Reference implementation exists at `/src/app/(dashboard)/admin/services/`

**Task 2: Analyze Profile Suppliers Current State**
- **Goal**: Document what needs to change in current implementation
- **Deliverables**:
  - Current component structure (247 lines)
  - Current navigation flow (separate pages)
  - Current mutation handling
  - Migration path from old to new pattern
- **Status**: Current implementation at `/src/app/(dashboard)/admin/profile-suppliers/`

**Task 3: Validate tRPC Procedures**
- **Goal**: Confirm existing API supports dialog modal pattern
- **Deliverables**:
  - List of available procedures (create, update, delete, list, getById)
  - Input/output schemas
  - Authorization checks (adminProcedure)
- **Status**: Procedures exist at `/src/server/api/routers/admin/profile-supplier.ts`

**Task 4: Review Validation Schema**
- **Goal**: Confirm form validation schema is complete
- **Deliverables**:
  - Field validations (name, materialType, notes, isActive)
  - Error messages in Spanish
  - Schema compatibility with React Hook Form
- **Status**: Schema exists at `/src/lib/validations/admin/profile-supplier.schema.ts`

### Research Consolidation

All findings will be documented in `research.md` with sections:

1. **Services Module Pattern Analysis**
   - Hook pattern (form state + mutations)
   - Dialog modal composition
   - SSR cache invalidation (invalidate + router.refresh)

2. **Current Profile Suppliers Analysis**
   - Problems with current implementation
   - Code that can be reused
   - Code that must be rewritten

3. **API Contract Validation**
   - tRPC procedures coverage
   - Schema validation rules
   - Authorization enforcement

4. **Best Practices Confirmation**
   - SOLID principles application
   - Next.js 15 patterns
   - Testing strategy

**Output**: `research.md` with all decisions, rationales, and alternatives documented.

---

## Phase 1: Design & Contracts

### Data Model

**Entity**: ProfileSupplier (existing, no changes)

```prisma
model ProfileSupplier {
  id           String       @id @default(cuid())
  name         String       @unique
  materialType MaterialType
  notes        String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations (unchanged)
  profiles     Profile[]
}

enum MaterialType {
  PVC
  ALUMINUM
  WOOD
  MIXED
}
```

**Validation Rules** (existing):
- `name`: 3-100 characters, required, unique
- `materialType`: enum value, required
- `notes`: max 500 characters, optional
- `isActive`: boolean, default true

**State Transitions**: None (simple CRUD, no workflow states)

**Output**: `data-model.md` documenting entity structure and validation rules.

### API Contracts

**Existing tRPC Procedures** (no changes needed):

```typescript
// api.admin['profile-supplier'].list
Input: {
  page?: number;
  search?: string;
  materialType?: MaterialType;
  isActive?: boolean;
}
Output: {
  items: ProfileSupplier[];
  total: number;
  page: number;
  totalPages: number;
}

// api.admin['profile-supplier'].create
Input: {
  name: string;
  materialType: MaterialType;
  notes?: string;
  isActive?: boolean;
}
Output: ProfileSupplier

// api.admin['profile-supplier'].update
Input: {
  id: string;
  name: string;
  materialType: MaterialType;
  notes?: string;
  isActive?: boolean;
}
Output: ProfileSupplier

// api.admin['profile-supplier'].delete
Input: {
  id: string;
}
Output: void

// api.admin['profile-supplier'].getById
Input: {
  id: string;
}
Output: ProfileSupplier | null
```

**Output**: `contracts/api.md` documenting tRPC procedures and `contracts/schemas.md` for Zod schemas.

### Component Contracts

**New Custom Hooks**:

```typescript
// use-profile-supplier-form.ts
export function useProfileSupplierForm(props: {
  mode: 'create' | 'edit';
  open: boolean;
  defaultValues?: ProfileSupplier;
}): {
  form: UseFormReturn<FormValues>;
  // No auto-assignment needed (materialType is explicit choice)
}

// use-profile-supplier-mutations.ts
export function useProfileSupplierMutations(props: {
  onSuccess?: () => void;
}): {
  handleCreate: (data: FormValues) => Promise<void>;
  handleUpdate: (id: string, data: FormValues) => Promise<void>;
  isPending: boolean;
}
```

**New Dialog Component**:

```typescript
// profile-supplier-dialog.tsx
export function ProfileSupplierDialog(props: {
  mode: 'create' | 'edit';
  open: boolean;
  onOpenChange: (open: boolean) => void;
  defaultValues?: ProfileSupplier;
}): JSX.Element
```

### Architecture Documentation

**Output**: `README.md` in `_components/` directory documenting:

- SOLID principles application
- Hook responsibilities
- Component composition pattern
- Testing strategy
- Migration notes from old pattern

### Agent Context Update

Run `.specify/scripts/bash/update-agent-context.sh copilot` to update agent-specific context with:
- Dialog modal pattern for profile suppliers
- Custom hooks for form state and mutations
- SSR cache invalidation pattern application

**Output**: Updated `.github/copilot-instructions.md` with profile suppliers pattern example.

### Quickstart Guide

**Output**: `quickstart.md` with:

1. **Setup**:
   ```bash
   git checkout 012-simplify-profile-suppliers
   pnpm install
   pnpm db:generate
   ```

2. **Development**:
   ```bash
   pnpm dev
   # Navigate to http://localhost:3000/admin/profile-suppliers
   ```

3. **Testing**:
   ```bash
   # Unit tests for hooks
   pnpm test src/app/(dashboard)/admin/profile-suppliers/_hooks
   
   # E2E tests for user flows
   pnpm test:e2e e2e/admin/profile-suppliers.spec.ts
   ```

4. **Code Quality**:
   ```bash
   pnpm lint:fix
   pnpm typecheck
   ```

---

## Phase 2: Implementation Planning

**Status**: This phase is completed by the `/speckit.tasks` command (NOT by `/speckit.plan`).

The tasks.md file will break down implementation into:
- Specific code changes
- Test creation
- Documentation updates
- Verification steps

---

## Next Steps

1. **Review this plan**: Validate all research tasks and design decisions
2. **Execute Phase 0**: Run research tasks to populate `research.md`
3. **Execute Phase 1**: Generate data model, contracts, and quickstart docs
4. **Update agent context**: Run update script to sync copilot instructions
5. **Proceed to Phase 2**: Run `/speckit.tasks` to generate implementation tasks

**Branch**: `012-simplify-profile-suppliers` (already created)
**Spec File**: `/home/andres/Proyectos/glasify-lite/specs/012-simplify-profile-suppliers/spec.md`
**Plan File**: `/home/andres/Proyectos/glasify-lite/specs/012-simplify-profile-suppliers/plan.md` (this file)

---

## Appendix: Reference Files

### Services Module (Reference Implementation)
- `/src/app/(dashboard)/admin/services/page.tsx` - SSR page pattern
- `/src/app/(dashboard)/admin/services/_hooks/use-service-form.ts` - Form hook (~95 lines)
- `/src/app/(dashboard)/admin/services/_hooks/use-service-mutations.ts` - Mutations hook (~98 lines)
- `/src/app/(dashboard)/admin/services/_components/service-dialog.tsx` - Dialog component (~191 lines)
- `/src/app/(dashboard)/admin/services/_components/services-list.tsx` - List with CRUD actions
- `/src/app/(dashboard)/admin/services/_components/README.md` - Architecture documentation

### Current Profile Suppliers Implementation
- `/src/app/(dashboard)/admin/profile-suppliers/page.tsx` - SSR page (keep)
- `/src/app/(dashboard)/admin/profile-suppliers/_components/profile-supplier-form.tsx` - Monolithic form (replace)
- `/src/app/(dashboard)/admin/profile-suppliers/new/page.tsx` - Create page (remove)
- `/src/app/(dashboard)/admin/profile-suppliers/[id]/page.tsx` - Edit page (remove)

### API & Validation
- `/src/server/api/routers/admin/profile-supplier.ts` - tRPC procedures
- `/src/lib/validations/admin/profile-supplier.schema.ts` - Zod schemas

### Documentation
- `.github/copilot-instructions.md` - SSR cache invalidation pattern section
- `.specify/memory/constitution.md` - SOLID principles, Server-First Performance
