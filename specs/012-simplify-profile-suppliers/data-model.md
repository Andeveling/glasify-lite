# Data Model: Profile Suppliers

**Feature**: 012-simplify-profile-suppliers  
**Phase**: 1 (Design & Contracts)  
**Date**: 2025-01-20

## Entity Overview

### ProfileSupplier

Represents a manufacturer of window and door frames (perfiles). Suppliers are categorized by the primary material they work with (PVC, Aluminum, Wood, or Mixed).

**Domain**: Admin catalog management  
**Access**: Admin users only (enforced by adminProcedure)  
**Operations**: Full CRUD (Create, Read, Update, Delete)

---

## Prisma Schema

```prisma
model ProfileSupplier {
  id           String       @id @default(cuid())
  name         String       @unique
  materialType MaterialType
  notes        String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations
  profiles     Profile[]

  @@index([name])
  @@index([materialType])
  @@index([isActive])
  @@map("profile_suppliers")
}

enum MaterialType {
  PVC
  ALUMINUM
  WOOD
  MIXED
}
```

**Notes**:
- `@@map("profile_suppliers")`: Database table name (snake_case)
- Indexes on `name`, `materialType`, `isActive` for query performance
- `createdAt`/`updatedAt`: Automatic timestamps via Prisma

---

## Field Definitions

### id (String)

**Type**: CUID (Collision-resistant Unique Identifier)  
**Constraints**: Primary key, generated by Prisma  
**Purpose**: Unique identifier for the supplier  
**Validation**: None (auto-generated)

**Examples**:
- `cl8x7y6z50000356abc123def`
- `cm2a3b4c60001789xyz456ghi`

### name (String)

**Type**: Text  
**Constraints**: Unique, required, 3-100 characters  
**Purpose**: Display name of the supplier (e.g., "Rehau", "Deceuninck")  
**Validation**: Zod schema (see Validation Rules section)

**Examples**:
- ✅ "Rehau Colombia"
- ✅ "Deceuninck"
- ✅ "Aluminios del Sur S.A."
- ❌ "AB" (too short)
- ❌ "" (empty)

**UI**: Text input with real-time validation

### materialType (MaterialType enum)

**Type**: Enum (PVC | ALUMINUM | WOOD | MIXED)  
**Constraints**: Required, one of 4 values  
**Purpose**: Primary material the supplier works with  
**Validation**: Zod enum validation

**Values**:
- `PVC`: PVC (polyvinyl chloride) profiles
- `ALUMINUM`: Aluminum profiles
- `WOOD`: Wood profiles
- `MIXED`: Supplier works with multiple materials

**Examples**:
- ✅ "PVC"
- ✅ "ALUMINUM"
- ❌ "METAL" (not in enum)

**UI**: Select dropdown with Spanish labels:
- PVC → "PVC"
- ALUMINUM → "Aluminio"
- WOOD → "Madera"
- MIXED → "Mixto"

### notes (String, optional)

**Type**: Text (long form)  
**Constraints**: Optional, max 500 characters  
**Purpose**: Additional information about the supplier  
**Validation**: Zod max length validation

**Examples**:
- ✅ "Proveedor preferido para proyectos residenciales"
- ✅ null (no notes)
- ✅ "" (empty string)
- ❌ 501+ character string

**UI**: Textarea with character counter

### isActive (Boolean)

**Type**: Boolean  
**Constraints**: Default true  
**Purpose**: Soft delete flag (inactive suppliers hidden from selection but not deleted)  
**Validation**: Boolean validation

**Values**:
- `true`: Supplier is active and available for selection
- `false`: Supplier is inactive (hidden from selection, but historical data preserved)

**Examples**:
- ✅ true (default for new suppliers)
- ✅ false (supplier no longer operates)

**UI**: Checkbox ("Activo")

### createdAt (DateTime)

**Type**: Timestamp  
**Constraints**: Auto-generated by Prisma  
**Purpose**: Audit trail (when supplier was added)  
**Validation**: None (auto-generated)

**Examples**:
- `2025-01-20T14:30:00.000Z`

**UI**: Display only (not editable)

### updatedAt (DateTime)

**Type**: Timestamp  
**Constraints**: Auto-updated by Prisma on every change  
**Purpose**: Audit trail (when supplier was last modified)  
**Validation**: None (auto-generated)

**Examples**:
- `2025-01-20T16:45:00.000Z`

**UI**: Display only (not editable)

---

## Validation Rules

### Create Validation (createProfileSupplierSchema)

```typescript
import { z } from 'zod';

export const MIN_NAME_LENGTH = 3;
export const MAX_NAME_LENGTH = 100;
export const MAX_NOTES_LENGTH = 500;

export const createProfileSupplierSchema = z.object({
  name: z
    .string({
      required_error: 'El nombre es requerido',
      invalid_type_error: 'El nombre debe ser un texto',
    })
    .min(MIN_NAME_LENGTH, {
      message: `El nombre debe tener al menos ${MIN_NAME_LENGTH} caracteres`,
    })
    .max(MAX_NAME_LENGTH, {
      message: `El nombre no puede exceder ${MAX_NAME_LENGTH} caracteres`,
    })
    .trim(),
  
  materialType: z.enum(['PVC', 'ALUMINUM', 'WOOD', 'MIXED'], {
    required_error: 'El tipo de material es requerido',
    invalid_type_error: 'Tipo de material inválido',
  }),
  
  notes: z
    .string()
    .max(MAX_NOTES_LENGTH, {
      message: `Las notas no pueden exceder ${MAX_NOTES_LENGTH} caracteres`,
    })
    .optional(),
  
  isActive: z.boolean().default(true),
});

export type CreateProfileSupplierInput = z.infer<typeof createProfileSupplierSchema>;
```

### Update Validation (updateProfileSupplierSchema)

```typescript
export const updateProfileSupplierSchema = z.object({
  id: z.string().cuid(),
  name: z.string().min(MIN_NAME_LENGTH).max(MAX_NAME_LENGTH).trim(),
  materialType: z.enum(['PVC', 'ALUMINUM', 'WOOD', 'MIXED']),
  notes: z.string().max(MAX_NOTES_LENGTH).optional(),
  isActive: z.boolean(),
});

export type UpdateProfileSupplierInput = z.infer<typeof updateProfileSupplierSchema>;
```

**Key Differences**:
- Update requires `id` field
- Update makes `isActive` required (explicit choice)

---

## Relationships

### profiles (Profile[], one-to-many)

**Relation**: ProfileSupplier → Profile  
**Type**: One-to-many (one supplier can have many profile designs)  
**Foreign Key**: `Profile.profileSupplierId`

**Purpose**: Links supplier to their catalog of profile designs

**Cascade Behavior**:
- Delete supplier: RESTRICT (cannot delete if profiles exist)
- Soft delete preferred: Set `isActive = false` instead

**Usage**:
```typescript
// Get supplier with their profiles
const supplier = await prisma.profileSupplier.findUnique({
  where: { id: 'supplier-id' },
  include: { profiles: true },
});
```

---

## State Transitions

ProfileSupplier has no complex state machine. Only two states:

```
[ACTIVE] ←→ [INACTIVE]
```

**Transitions**:
- New supplier created → ACTIVE (default)
- Admin deactivates → INACTIVE
- Admin reactivates → ACTIVE

**Business Rules**:
- ACTIVE suppliers appear in selection dropdowns
- INACTIVE suppliers hidden from selection but data preserved
- Historical quotes/profiles still reference inactive suppliers

---

## Indexes & Performance

### Database Indexes

```prisma
@@index([name])           // For search queries (e.g., "LIKE '%Rehau%'")
@@index([materialType])   // For filtering by material
@@index([isActive])       // For filtering active suppliers
```

**Query Patterns**:

```sql
-- Search by name (uses name index)
SELECT * FROM profile_suppliers 
WHERE name ILIKE '%rehau%' AND is_active = true;

-- Filter by material (uses materialType index)
SELECT * FROM profile_suppliers 
WHERE material_type = 'PVC' AND is_active = true;

-- List active suppliers (uses isActive index)
SELECT * FROM profile_suppliers 
WHERE is_active = true 
ORDER BY name ASC;
```

### Performance Targets

- List query: <100ms (paginated)
- Create: <200ms
- Update: <200ms
- Delete: <50ms (simple WHERE clause)
- Search: <100ms (indexed name column)

---

## Example Data

### Typical ProfileSupplier Records

```typescript
const examples = [
  {
    id: 'clxyz123',
    name: 'Rehau Colombia',
    materialType: 'PVC',
    notes: 'Proveedor líder en perfiles PVC para ventanas y puertas',
    isActive: true,
    createdAt: new Date('2025-01-15T10:00:00Z'),
    updatedAt: new Date('2025-01-15T10:00:00Z'),
  },
  {
    id: 'clxyz456',
    name: 'Deceuninck',
    materialType: 'PVC',
    notes: 'Sistemas de alta eficiencia energética',
    isActive: true,
    createdAt: new Date('2025-01-16T14:30:00Z'),
    updatedAt: new Date('2025-01-16T14:30:00Z'),
  },
  {
    id: 'clxyz789',
    name: 'Aluminios del Sur S.A.',
    materialType: 'ALUMINUM',
    notes: null,
    isActive: true,
    createdAt: new Date('2025-01-17T09:15:00Z'),
    updatedAt: new Date('2025-01-17T09:15:00Z'),
  },
  {
    id: 'clxyz012',
    name: 'Maderas Premium',
    materialType: 'WOOD',
    notes: 'Especialistas en perfiles de madera maciza',
    isActive: false, // Inactive supplier
    createdAt: new Date('2024-12-01T08:00:00Z'),
    updatedAt: new Date('2025-01-10T11:20:00Z'),
  },
];
```

---

## Edge Cases & Constraints

### Unique Name Constraint

**Case**: Two suppliers with same name  
**Behavior**: Database throws unique constraint error  
**Handling**: Show Spanish error message "Ya existe un proveedor con este nombre"

```typescript
// tRPC procedure handles Prisma unique constraint error
if (error.code === 'P2002') {
  throw new TRPCError({
    code: 'CONFLICT',
    message: 'Ya existe un proveedor con este nombre',
  });
}
```

### Deleting Supplier with Profiles

**Case**: Admin tries to delete supplier that has profiles  
**Behavior**: Cannot delete (foreign key constraint)  
**Handling**: Suggest soft delete (set isActive = false)

```typescript
// tRPC delete procedure checks for relationships
const profileCount = await ctx.db.profile.count({
  where: { profileSupplierId: input.id },
});

if (profileCount > 0) {
  throw new TRPCError({
    code: 'BAD_REQUEST',
    message: `No se puede eliminar el proveedor porque tiene ${profileCount} perfiles asociados. Desactívalo en su lugar.`,
  });
}
```

### Trimming Whitespace

**Case**: User enters "  Rehau  " (with spaces)  
**Behavior**: Zod schema trims automatically  
**Result**: Stored as "Rehau"

### Empty Notes vs Null Notes

**Case**: User submits form with empty notes field  
**Behavior**: Empty string "" converted to null in database  
**Reason**: Semantic clarity (null = no data, "" = explicit empty)

---

## Testing Data

### Seed Data (for development)

```typescript
// prisma/seeders/profile-suppliers.seeder.ts
export async function seedProfileSuppliers(prisma: PrismaClient) {
  const suppliers = [
    { name: 'Rehau', materialType: 'PVC', isActive: true },
    { name: 'Deceuninck', materialType: 'PVC', isActive: true },
    { name: 'Aluminios del Sur', materialType: 'ALUMINUM', isActive: true },
    { name: 'Maderas Premium', materialType: 'WOOD', isActive: false },
  ];

  for (const supplier of suppliers) {
    await prisma.profileSupplier.upsert({
      where: { name: supplier.name },
      update: {},
      create: supplier,
    });
  }
}
```

### Test Cases

**Valid Inputs**:
- Minimal: `{ name: "ABC", materialType: "PVC" }`
- Complete: `{ name: "Rehau", materialType: "PVC", notes: "...", isActive: true }`

**Invalid Inputs**:
- Short name: `{ name: "AB", materialType: "PVC" }` → Error
- Long name: `{ name: "A".repeat(101), materialType: "PVC" }` → Error
- Invalid material: `{ name: "Rehau", materialType: "STEEL" }` → Error
- Long notes: `{ name: "Rehau", materialType: "PVC", notes: "A".repeat(501) }` → Error

---

## Summary

**Entity**: ProfileSupplier  
**Complexity**: Low (simple CRUD entity)  
**Fields**: 8 (4 user-editable, 4 system-managed)  
**Relationships**: 1 (one-to-many with Profile)  
**Validation**: Standard (length checks, enum validation)  
**State Machine**: None (simple active/inactive toggle)  
**Indexes**: 3 (name, materialType, isActive)

**No database migrations needed** - schema already exists and is unchanged.
