# Implementation Plan: Geocoded Delivery Addresses for Quotes

**Branch**: `001-delivery-address` | **Date**: 2025-11-01 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/001-delivery-address/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Add structured geographic delivery address support to the quote system, enabling sellers to specify precise delivery locations using autocomplete/geocoding, capture coordinates, and automatically calculate transportation costs based on distance from warehouse to construction site. Primary use case: "quote in Buga, deliver to Medellín". Technical approach uses Nominatim geocoding API with fallback to manual entry, Haversine distance calculation, and optional map visualization.

## Technical Context

**Language/Version**: TypeScript 5.9.3 (strict mode), Node.js ES2022  
**Primary Dependencies**: Next.js 16.0.1 (App Router), React 19.2.0, tRPC 11.6.0, Prisma 6.18.0, Zod 4.1.12, React Hook Form 7.64.0  
**Storage**: PostgreSQL (existing instance) - add `ProjectAddress` model, modify `Quote` and `TenantConfig` models  
**Testing**: Vitest 4.0.4 (unit/integration), Playwright 1.56.0 (E2E)  
**Target Platform**: Web application (Next.js SSR/SSG with Client Components for interactivity)  
**Project Type**: Web application (Next.js 16 App Router monorepo)  
**Performance Goals**:  
  - Autocomplete response time: <500ms per keystroke (debounced to 300ms)  
  - Distance calculation: <100ms for any coordinate pair  
  - Transportation cost update: <500ms after address selection  
  - Geocoding API timeout: 5 seconds with graceful fallback to manual entry  

**Constraints**:  
  - LATAM-specific: Support addresses without postal codes (nullable field)  
  - Offline-capable manual entry when geocoding API unavailable  
  - Haversine straight-line distance acceptable for MVP (±5% accuracy vs road distance)  
  - Coordinate precision: 7 decimal places (Decimal(10,7) in PostgreSQL)  
  - Backward compatibility: Existing `Quote.projectCity/projectStreet` fields must remain functional during migration  

**Scale/Scope**:  
  - Expected addresses: ~500-1000 per month (growing with user base)  
  - Geocoding API calls: ~100-200/day (debounced autocomplete reduces requests)  
  - Database indexes: 3 new indexes on `ProjectAddress` (quoteId, city, lat/lon)  
  - UI components: 1 address picker component, 3-4 utility hooks, 2-3 utility functions  

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: `.specify/memory/constitution.md` - verify feature complies with all principles.

### Core Values Compliance

- [x] **Clarity Over Complexity**: Design uses clear, descriptive names and simple logic
  - ✅ Clear entity names: `ProjectAddress`, `DeliveryAddressPicker`, `haversineDistance()`
  - ✅ Simple logic: address autocomplete → select → calculate distance → apply rate
  - ✅ No clever abstractions: direct Nominatim API calls, standard Haversine formula

- [x] **Server-First Performance**: Heavy work done on server, appropriate caching strategy defined
  - [x] Caching strategy documented:
    - **Tenant warehouse location**: 5-minute cache (rarely changes, read from `TenantConfig`)
    - **Geocoding results**: No caching (API responses vary by query, autocomplete ephemeral)
    - **Distance calculations**: No caching (pure function, computed on-demand <100ms)
    - **Quote with address**: Standard quote caching (user-specific, short cache or none)
  - [x] SSR mutations use two-step invalidation:
    - Create/update address: `utils.quote.getById.invalidate()` + `router.refresh()`
    - Update delivery address: `utils.quote.list.invalidate()` + `router.refresh()`

- [x] **One Job, One Place (SOLID Architecture)**: Modular architecture with clear separation
  - [x] Forms follow mandatory file organization:
    ```
    quotes/_components/delivery-address-picker.tsx  # UI orchestration <150 lines
    quotes/_hooks/use-address-autocomplete.ts       # Geocoding API + debounce
    quotes/_hooks/use-address-mutations.ts          # Create/update ProjectAddress
    quotes/_hooks/use-transportation-cost.ts        # Distance calc + cost formula
    quotes/_schemas/project-address.schema.ts       # Zod validation
    quotes/_utils/address-formatter.ts              # formatAddress(), parseCoordinates()
    quotes/_utils/distance-calculator.ts            # haversineDistance(), validateCoords()
    quotes/_utils/address-defaults.ts               # getEmptyAddress()
    quotes/_constants/geocoding.constants.ts        # MIN_LAT, MAX_LAT, API_TIMEOUT, etc.
    ```
  - [x] No SOLID violations:
    - ✅ Forms <150 lines UI-only (address picker orchestrates hooks, renders UI)
    - ✅ Mutations in hooks (`use-address-mutations.ts` handles tRPC calls + cache)
    - ✅ Schemas extracted (`project-address.schema.ts` with coordinate validation)
    - ✅ Magic numbers extracted (coordinate ranges, timeout values, default zoom levels)
    - ✅ Default values in utils (`getEmptyAddress()` returns initial state)
    - ✅ Business logic separated (distance calculation in pure function, not component)

- [x] **Flexible Testing**: Testing strategy defined (tests before merge to main)
  - **Unit Tests** (Vitest):
    - `haversineDistance()` function with known coordinate pairs
    - `formatAddress()` with various address combinations (null fields, partial data)
    - `validateCoordinates()` with edge cases (boundary values, invalid ranges)
    - Zod schema validation with valid/invalid inputs
  - **Integration Tests** (Vitest + tRPC):
    - Create `ProjectAddress` via tRPC mutation
    - Update quote with `projectAddressId`
    - Fetch quote with populated address relationship
    - Calculate transportation cost with warehouse location
  - **E2E Tests** (Playwright):
    - User Story 1: Type city name → select from autocomplete → verify coordinates saved
    - User Story 2: Manual address entry → save → verify text fields persisted
    - User Story 3: Select delivery address → verify transportation cost appears in quote total
  - **Test Timing**: Write unit tests during development, integration tests after tRPC endpoints complete, E2E tests before merge

- [x] **Extend, Don't Modify**: New features add code, don't change existing working code
  - ✅ New `ProjectAddress` model added (doesn't modify `Quote` structure)
  - ✅ Optional foreign key `Quote.projectAddressId` (existing quotes unaffected)
  - ✅ Existing `projectCity/projectStreet` fields remain functional (deprecated but not removed)
  - ✅ New address picker component added alongside existing form fields (no rewrites)
  - ✅ Migration script creates new records, doesn't alter existing quote data

- [x] **Security From the Start**: Input validation and authorization checks at every entry point
  - [x] User permissions checked server-side:
    - ✅ tRPC `adminProcedure` for address CRUD (only admin/seller roles)
    - ✅ Ownership validation: users can only modify addresses on their own quotes
    - ✅ No client-side authorization (UI guards are UX, not security)
  - [x] All user input validated with Zod schemas:
    - ✅ `projectAddressSchema`: validates coordinate ranges, field lengths, required fields
    - ✅ Server-side validation in tRPC procedures (rejects invalid data before DB persist)
    - ✅ Geocoding API responses sanitized (only extract trusted fields: lat, lon, city, etc.)

- [x] **Track Everything Important**: Logging strategy defined for errors and significant events
  - [x] Winston logger used ONLY in server-side code:
    - ✅ Log geocoding API failures (error level, with address query + error message)
    - ✅ Log transportation cost calculations (info level, with distance + cost)
    - ✅ Log address creation/updates (info level, with quoteId + addressId)
    - ❌ Never log full addresses with PII (only log city/region for diagnostics)
    - ❌ Never use Winston in Client Components (use console for development, toast for users)
  - [x] Error messages to users in Spanish, technical logs in English:
    - ✅ User error: "No se pudo encontrar la dirección. Intenta ingresar manualmente."
    - ✅ Technical log: "Geocoding API timeout for query 'Medellín Antioquia' after 5000ms"

### Language & Communication

- [x] Code/comments/commits in English only
  - ✅ Function names: `formatAddress()`, `calculateTransportationCost()`
  - ✅ Comments: "// Calculate Haversine distance between two coordinates"
  - ✅ Commits: "feat: add geocoded delivery address support to quotes"
  
- [x] UI text in Spanish (es-LA) only
  - ✅ Field labels: "Dirección de entrega", "Ciudad", "Referencia"
  - ✅ Buttons: "Buscar dirección", "Ingresar manualmente"
  - ✅ Errors: "La dirección es requerida", "Coordenadas inválidas"
  
- [x] Commit messages follow Conventional Commits format
  - ✅ Examples: `feat(quotes): add ProjectAddress model`, `refactor(utils): extract distance calculator`

### Technology Constraints

- [x] Uses required stack: Next.js 16 (App Router), TypeScript (strict), React 19, tRPC, Prisma, PostgreSQL
  - ✅ Next.js 16 App Router with Server Components for data fetching
  - ✅ Client Components only for address picker interactivity (autocomplete, map)
  - ✅ tRPC for type-safe address CRUD endpoints
  - ✅ Prisma schema migration for `ProjectAddress` model
  - ✅ TypeScript strict mode with full type coverage
  
- [x] No prohibited technologies
  - ✅ No Vue/Angular/Svelte (using React 19)
  - ✅ No alternative CSS frameworks (using TailwindCSS for address picker UI)
  - ✅ Winston only in server-side tRPC procedures (never in browser)
  
- [x] UI components use Shadcn/ui + Radix UI + TailwindCSS
  - ✅ Address picker uses Shadcn `Input`, `Popover`, `Command` components
  - ✅ Autocomplete dropdown uses Radix `Popover` primitive
  - ✅ Map visualization (P3) uses lazy-loaded `react-map-gl` with Shadcn card wrapper

### Cache Components Best Practices

- [x] Cache Components compatibility verified
  - ✅ No `"use cache"` in address picker (Client Component with user interaction)
  - ✅ No `headers()` or `cookies()` in cached functions (not using Cache Components for this feature)
  - ✅ Warehouse location fetch uses standard Server Component data fetching (no caching directive needed)
  - ✅ Distance calculation is pure function (no caching, computed on-demand)
  - ❌ Feature doesn't use Cache Components (dynamic user input, no build-time prerendering)

### Quality Gates

- [x] TypeScript strict mode enabled, no type errors expected
  - ✅ All address types defined in `address.types.ts`
  - ✅ Zod schemas infer TypeScript types for runtime validation
  - ✅ tRPC procedures fully typed (input/output schemas)
  
- [x] Biome/Ultracite formatting rules followed
  - ✅ Auto-format on save configured in project
  - ✅ Pre-commit hook runs Biome linter
  
- [x] Tests planned for all user journeys (unit/integration/E2E as appropriate)
  - ✅ See "Flexible Testing" section above for detailed test plan
  
- [x] Changelog entry planned for user-facing changes
  - ✅ Entry: "feat: Agregada selección de dirección de entrega con geocodificación y cálculo automático de costos de transporte"
  
- [x] Migration notes prepared if breaking changes
  - ✅ Migration script documented in spec.md (migrate `projectCity/projectStreet` to `ProjectAddress`)
  - ⚠️ No breaking changes (backward compatible - existing fields remain functional)

### Principle Priority Resolution

No principle conflicts detected. All principles align:
- Security (server-side validation) + SOLID (separated concerns) + Clarity (simple components) work together
- Server-First Performance (geocoding on server, caching warehouse location) complements Security (validate before DB)

**Result**: ✅ PASS - All constitution requirements satisfied

## Project Structure

### Documentation (this feature)

```text
specs/001-delivery-address/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output: Geocoding API comparison, distance algorithms
├── data-model.md        # Phase 1 output: ProjectAddress schema, relationships
├── quickstart.md        # Phase 1 output: How to use address picker component
├── contracts/           # Phase 1 output: tRPC procedure signatures
│   ├── address-crud.ts  # Create/update/delete ProjectAddress endpoints
│   └── geocoding.ts     # Geocoding API proxy endpoint
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
# Next.js 16 App Router Web Application (monorepo)

prisma/
├── schema.prisma                              # Add ProjectAddress model, modify Quote/TenantConfig
└── migrations/
    └── YYYYMMDDHHMMSS_add_project_address/    # Generated migration SQL
        └── migration.sql

src/
├── app/
│   └── (dashboard)/
│       └── admin/
│           └── quotes/
│               ├── _components/
│               │   ├── quote-form.tsx                    # Integrate address picker
│               │   └── delivery-address-picker.tsx       # New: Address selection UI
│               ├── _hooks/
│               │   ├── use-address-autocomplete.ts       # New: Geocoding API + debounce
│               │   ├── use-address-mutations.ts          # New: CRUD mutations
│               │   └── use-transportation-cost.ts        # New: Distance calc + cost
│               ├── _schemas/
│               │   └── project-address.schema.ts         # New: Zod validation
│               ├── _utils/
│               │   ├── address-formatter.ts              # New: Format/parse utilities
│               │   ├── distance-calculator.ts            # New: Haversine formula
│               │   └── address-defaults.ts               # New: Default values
│               ├── _constants/
│               │   └── geocoding.constants.ts            # New: API config, coord limits
│               └── _types/
│                   └── address.types.ts                  # New: TypeScript types
│
├── server/
│   ├── api/
│   │   └── routers/
│   │       ├── quote.ts                                  # Modify: Add address population
│   │       └── address.ts                                # New: Address CRUD router
│   ├── services/
│   │   ├── geocoding.service.ts                          # New: Nominatim API client
│   │   └── transportation.service.ts                     # New: Distance + cost calculation
│   └── db.ts                                             # No changes (existing Prisma client)
│
└── lib/
    └── utils/
        └── coordinates.ts                                # New: Coordinate validation helpers

tests/
├── unit/
│   ├── distance-calculator.test.ts                       # Haversine function tests
│   ├── address-formatter.test.ts                         # Formatting utility tests
│   └── project-address-schema.test.ts                    # Zod validation tests
├── integration/
│   └── address-crud.test.ts                              # tRPC endpoint tests
└── e2e/
    └── delivery-address-flow.spec.ts                     # Playwright: Address selection flow

e2e/
└── fixtures/
    └── addresses.json                                    # Test data: Sample addresses with coords
```

**Structure Decision**: Standard Next.js 16 App Router monorepo structure. New feature code lives in `/app/(dashboard)/admin/quotes/` feature folder following SOLID file organization (_components, _hooks, _schemas, _utils, _constants, _types). Server-side logic in `/server/api/routers/` and `/server/services/`. Tests mirror source structure in `/tests/` directory.

## Complexity Tracking

No constitution violations requiring justification. All complexity is essential:

| Aspect                   | Justification                                                                                              |
| ------------------------ | ---------------------------------------------------------------------------------------------------------- |
| External API (Nominatim) | Required for geocoding - no simpler alternative for address → coordinates conversion                       |
| Haversine formula        | Standard algorithm for distance calculation - no simpler alternative for lat/lon → km conversion           |
| Manual entry fallback    | Required for LATAM rural addresses without geocoding - addresses "no postal code" requirement              |
| Separate service layer   | Follows SOLID - geocoding logic separated from tRPC router for testability and reusability                 |
| Multiple utility files   | Follows constitution "One Job, One Place" - each file has single responsibility (format, calc, validate)   |
| Migration script         | Required for zero-downtime deployment - preserves existing `projectCity/projectStreet` data during rollout |
