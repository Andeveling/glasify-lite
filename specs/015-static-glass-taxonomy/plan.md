# Implementation Plan: Static Glass Taxonomy Based on Industry Standards

**Branch**: `015-static-glass-taxonomy` | **Date**: 2025-10-22 | **Spec**: `/specs/015-static-glass-taxonomy/spec.md`
**Input**: Feature specification from `/specs/015-static-glass-taxonomy/spec.md` | **Status**: Planning Phase

**Note**: This plan is generated by the `/speckit.plan` command workflow. See `.specify/templates/commands/plan.md` for execution details.

## Summary

Convert GlassType and GlassSolution to a **hybrid static/dynamic taxonomy** based on industry standards. Seed 30 standard Tecnoglass types (serie-R, serie-N, Solarban) marked `isSeeded: true` during deployment. Admin users retain full CRUD capabilities for custom types (`isSeeded: false`). Remove all deprecated fields (isTempered, isLaminated, isLowE, isTripleGlazed, purpose, glassSupplierId, pricePerSqm, sku) and establish clean schema foundation. Implement admin-only RBAC for glass taxonomy management. GlassSolution remains fully static (seed-only, no CRUD).

**Technical Approach**: Schema migration → seed data with GlassCharacteristic + GlassTypeSolution relationships → tRPC admin procedures with authorization → UI components for glass type management.

## Technical Context

**Language/Version**: TypeScript 5.9.3 (strict mode), Node.js ES2022 target via Next.js 15.5.4  
**Primary Dependencies**: 
- Next.js 15.5.4 (App Router, React Server Components 19.0.0)
- tRPC 11.6.0 (type-safe API procedures)
- Prisma 6.17.0 (ORM, PostgreSQL)
- Zod 4.1.12 (schema validation)
- React Hook Form 7.64.0 (form management)

**Storage**: PostgreSQL via Prisma ORM (existing multi-tenant schema)  
**Testing**: Vitest 3.2.4 (unit/integration with jsdom), Playwright 1.55.1 (E2E tests)  
**Target Platform**: Web (Next.js full-stack application)
**Project Type**: Full-stack Next.js with React Server Components + tRPC  
**Performance Goals**: Glass catalog loads <500ms (in-memory seed data), admin list endpoint <200ms with pagination  
**Constraints**: 
- Clean schema (no deprecated fields)
- Admin-only CRUD (no tenant/seller escalation risk)
- Soft delete support (historical quotes preserve references)
- Pre-production advantage (no legacy data migration complexity)

**Scale/Scope**: 
- 30 seeded Tecnoglass types (static reference)
- ~10-15 GlassCharacteristic records (static reference)
- 6 GlassSolution records (static reference)
- Unlimited custom glass types via admin CRUD
- Tenant-specific supplier associations (existing model)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

This feature aligns with Glasify Lite Constitution v2.0.0 principles:

### Single Responsibility (SRP)
- [x] GlassType admin procedures separated from read-only catalog queries
- [x] GlassCharacteristic and GlassTypeSolution models have dedicated routers
- [x] tRPC procedures have single purpose (create, read, update, delete, list)
- [x] Business logic (authorization, seed strategy) in server services, not in tRPC directly

### Open/Closed (OCP)
- [x] Admin CRUD extends without modifying existing quote model
- [x] Seed data versioning allows future extensions (new characteristics, solutions)
- [x] GlassType hybrid model (seeded + custom) extensible without schema change
- [x] No breaking changes to existing GlassSupplier or QuoteItem models

### Pragmatic Testing Discipline
- [x] Unit tests for seed data validators (glass-type.factory.ts validation)
- [x] Contract tests for tRPC procedures (input/output schemas)
- [x] Integration tests for schema migration + seed execution
- [x] E2E tests for admin CRUD flows (create, update, delete glass types)
- [x] E2E tests for RBAC (verify non-admin cannot access endpoints)

### Server-First Architecture (Next.js 15)
- [x] Admin pages (glass type management) are Server Components by default
- [x] Client Components only for form interactivity, filters, modals in `_components/`
- [x] tRPC procedures for data fetching and mutations (not direct DB in components)
- [x] Dynamic rendering: `export const dynamic = 'force-dynamic'` for admin dashboard routes
- [x] Pattern: Server Page (fetches data) + Client Content (interactivity)

### Integration & Contract Testing
- [x] Contract tests for tRPC input/output schemas (Zod validation)
- [x] Integration tests for schema migration + seed data loading
- [x] Database layer tests for FK constraints and relationships
- [x] No external API dependencies (all seed data is static)

### Observability & Versioning
- [x] Winston logger for admin actions (create/update/delete glass types) server-side only
- [x] Authorization checks logged with correlation IDs
- [x] Seed data versioning strategy (v1.0 for MVP)
- [x] Semantic versioning: Data schema v1.0, seed data v1.0

### Technology Stack Compliance
- [x] Next.js 15 App Router with React Server Components
- [x] TypeScript (strict mode), Zod for validation, tRPC for APIs
- [x] Prisma 6.17.0 for PostgreSQL ORM
- [x] React Hook Form + Zod for admin forms
- [x] shadcn/ui + TailwindCSS for glass type management UI
- [x] Biome/Ultracite for code formatting and linting
- [x] UI text in Spanish (es-LA); code/comments in English

### Security & Compliance
- [x] Admin-only RBAC: Only role='admin' can CRUD glass types
- [x] Authorization checks in middleware + tRPC procedures
- [x] All tRPC inputs validated with Zod schemas
- [x] Soft delete pattern for data integrity (no hard deletes of seeded types)
- [x] Audit logging for sensitive operations (create/delete glass types)

### Development Workflow
- [x] Conventional commits: `feat: add hybrid glass type model` format
- [x] PR descriptions reference SOLID principles and Glasify Lite standards
- [x] CI gates: typecheck, lint, unit tests, E2E tests
- [x] Code review: 1 approver (2 for schema/authorization changes)

**Status**: ✅ All checks pass. Feature aligns with constitution. No violations to justify.

## Project Structure

### Documentation (this feature)

```
```
specs/015-static-glass-taxonomy/
├── spec.md                      # Feature specification (COMPLETE)
├── plan.md                      # Implementation plan (THIS FILE)
├── research.md                  # Phase 0: Research findings (TK)
├── data-model.md                # Phase 1: Data model schema (TK)
├── quickstart.md                # Phase 1: Developer quickstart (TK)
└── contracts/                   # Phase 1: API contracts
    ├── glass-type.contract.json      # tRPC input/output schemas
    ├── glass-characteristic.contract.json
    └── glass-type-solution.contract.json
```

### Source Code (Next.js 15 App Router)

```
src/
├── app/
│   └── (dashboard)/
│       └── admin/
│           └── glass-types/           # Glass type management routes
│               ├── page.tsx            # Server Component: list page with SSR
│               ├── _components/
│               │   ├── glass-types-table.tsx      # Client: table display + filters
│               │   ├── glass-type-form.tsx        # Client: create/edit form
│               │   └── glass-type-dialog.tsx      # Client: modal dialog
│               └── [id]/
│                   └── page.tsx        # Server Component: detail/edit page
│
├── server/
│   └── api/
│       ├── routers/
│       │   ├── admin/
│       │   │   ├── glass-type.ts     # tRPC admin procedures (CRUD)
│       │   │   ├── glass-characteristic.ts
│       │   │   └── glass-type-solution.ts
│       │   └── catalog/
│       │       └── glass-type.ts     # tRPC read-only procedures
│       └── trpc.ts                    # Base procedure + adminProcedure helper
│
├── lib/
│   └── format.ts                      # Currency, thickness formatters
│
└── components/
    └── ui/                            # Shadcn/ui atoms (unchanged)
```

**Additional Files**:

```
prisma/
├── schema.prisma                  # Schema migration: remove deprecated fields, add new models
├── migrations/                    # Prisma auto migrations
└── seeders/
    ├── glass-type.seeder.ts       # Seed 30 Tecnoglass types
    ├── glass-characteristic.seeder.ts  # Seed characteristics
    └── glass-type-solution.seeder.ts   # Seed GlassType → GlassSolution relationships

scripts/
├── migrate-glass-taxonomy.ts      # ✅ COMPLETE (Phase 2)
├── rollback-glass-taxonomy.ts     # ✅ COMPLETE (Phase 2)
└── validate-seed-data.ts          # ✅ COMPLETE (Phase 2)

tests/
├── unit/
│   ├── glass-type.factory.test.ts     # Seed data validation
│   └── glass-characteristic.factory.test.ts
├── integration/
│   ├── glass-type-migration.test.ts    # Schema migration + seed
│   └── glass-type-crud.test.ts         # tRPC procedures
└── e2e/
    └── admin/
        └── glass-types.spec.ts         # Admin CRUD flows + RBAC verification

docs/
└── glass-taxonomy-guide.md             # Developer guide for glass type system
```

**Structure Decision**: Next.js 15 App Router (single project) with route groups for `/admin/*` protected routes. Admin procedures in `server/api/routers/admin/` with shared catalog queries in `server/api/routers/catalog/`. Feature-specific UI in `app/(dashboard)/admin/glass-types/_components/`.

## Complexity Tracking

| Aspect                                      | Complexity | Mitigation                                                    |
| ------------------------------------------- | ---------- | ------------------------------------------------------------- |
| Hybrid CRUD model (seeded + custom)         | Medium     | Clear `isSeeded` flag, seed data marked immutable in comments |
| Admin-only RBAC                             | Low        | Use existing `adminProcedure` helper from tRPC setup          |
| Schema migration (remove 9 fields)          | Low        | Pre-production advantage, clean slate approach                |
| Seed data relationships (GlassTypeSolution) | Medium     | Factory pattern with seed data generators, validation tests   |
| Soft delete pattern (isActive flag)         | Low        | Existing pattern in Glasify, well-tested                      |
| Performance (30 types × 6 solutions)        | Low        | In-memory reference data, no pagination needed                |

---

## Phase 0: Research & Clarification

**Status**: ✅ COMPLETE (5/5 Q&A questions resolved)

### Resolved Ambiguities

1. **Q: GlassType CRUD model** → **A: Hybrid Model**
   - Seed 30 Tecnoglass types (marked `isSeeded: true`) during deployment
   - Admin can create/update/delete custom types (marked `isSeeded: false`)
   - Decision: Combines stability (seeded reference data) with flexibility (admin customization)

2. **Q: GlassCharacteristic + GlassTypeSolution seeding** → **A: Seed Both**
   - Seed ~10-15 GlassCharacteristic records (tempered, laminated, low-e, triple-glazed, acoustic, hurricane-resistant)
   - Seed GlassTypeSolution relationships for 30 Tecnoglass types with performanceRating
   - Decision: Enables admin to assign characteristics/solutions to custom types immediately

3. **Q: Deprecated fields handling** → **A: Delete Immediately**
   - Remove all 9 deprecated fields from schema (isTempered, isLaminated, isLowE, isTripleGlazed, purpose, glassSupplierId, pricePerSqm, sku, glassSupplier relation)
   - Clean schema foundation for v1.0 launch
   - Decision: Pre-production advantage, no legacy data to preserve

4. **Q: RBAC strategy** → **A: Admin-Only CRUD**
   - Only role='admin' can manage GlassType, GlassCharacteristic, GlassTypeSolution
   - Sellers/users have read-only access for catalog and quote creation
   - Decision: Prevents data corruption, ensures consistency

5. **Q: Legacy data migration** → **A: Clean Slate**
   - Delete all existing glass types from database
   - Start fresh with 30 seeded Tecnoglass types
   - Decision: Pre-production allows aggressive cleanup, no referential integrity issues

**Output**: All 5 clarifications documented in spec.md "## Clarifications" section. Architecture fully defined.

---

## Phase 1: Design & Contracts

*Expected Output*: data-model.md, contracts/*, quickstart.md, agent context update

### Data Model (Draft)

**GlassType** (Static Reference + Admin CRUD)
- id (PK, CUID)
- code: String (unique, e.g., "N70/38")
- name: String (Spanish, e.g., "Neutral Low-E")
- series: Enum (SERIE_R | SERIE_N | SOLARBAN)
- visibleTransmission: Float (%)
- solarTransmission: Float (%)
- exteriorReflectance: Float (%)
- interiorReflectance: Float (%)
- uValueWinter: Float (W/m²K)
- uValueSummer: Float (W/m²K)
- shgc: Float (Solar Heat Gain Coefficient)
- lsg: Float (Light to Solar Gain)
- substrateTypes: String[] (e.g., ["clear", "tinted", "reflective"])
- treatments: String[] (e.g., ["low-e", "tempered", "laminated"])
- isSeeded: Boolean (true for Tecnoglass, false for custom types)
- isActive: Boolean (soft delete flag)
- createdAt: DateTime
- updatedAt: DateTime
- Relationships:
  - Many-to-many: GlassCharacteristic (via GlassTypeCharacteristic join table)
  - Many-to-many: GlassSolution (via GlassTypeSolution join table, marked static)
  - One-to-many: QuoteItem (existing FK)

**GlassCharacteristic** (Static Reference - Seed Only)
- id (PK, CUID)
- code: String (unique, e.g., "TEMPERED")
- name: String (Spanish, e.g., "Templado")
- description: String (technical definition)
- category: Enum (TREATMENT | PERFORMANCE | SAFETY)
- isActive: Boolean
- createdAt: DateTime
- Relationships:
  - Many-to-many: GlassType

**GlassSolution** (Static Reference - Seed Only, NO CRUD)
- id (PK, CUID)
- code: String (unique, e.g., "SOLAR_CONTROL")
- name: String (Spanish, e.g., "Control Solar")
- description: String (technical definition with ISO/standards reference)
- certifications: String[] (e.g., ["LEED", "EDGE", "ISO 9050"])
- isActive: Boolean
- createdAt: DateTime
- Relationships:
  - Many-to-many: GlassType (via GlassTypeSolution, marked static)

**GlassTypeCharacteristic** (Join Table - Read Only)
- glassTypeId (FK)
- characteristicId (FK)
- performanceRating: Enum (BASIC | STANDARD | GOOD | VERY_GOOD | EXCELLENT)

**GlassTypeSolution** (Join Table - Seed Only, NO CRUD)
- glassTypeId (FK)
- solutionId (FK)
- performanceRating: Enum (BASIC | STANDARD | GOOD | VERY_GOOD | EXCELLENT)

### tRPC Procedures (Admin Routes - `/server/api/routers/admin/glass-type.ts`)

**Create**:
- Input: Zod schema for name, code, series, technical specs
- Validation: Unique code check, numeric ranges (transmission 0-100, U-value > 0)
- Output: Created GlassType with `isSeeded: false`
- Authorization: adminProcedure

**Read (List)**:
- Input: Pagination (page, limit), filters (series, isActive), search (code/name)
- Output: Paginated GlassType list with characteristic/solution associations
- Authorization: adminProcedure

**Read (Detail)**:
- Input: Glass type ID
- Output: GlassType with all relationships populated
- Authorization: adminProcedure

**Update**:
- Input: Glass type ID + partial update fields (cannot modify isSeeded for seeded types)
- Validation: Prevent modification of isSeeded flag for seeded types
- Output: Updated GlassType
- Authorization: adminProcedure

**Delete (Soft)**:
- Input: Glass type ID
- Logic: Set isActive = false, prevent deletion if custom type has active quotes (referential integrity)
- Output: Deleted GlassType (isActive: false)
- Authorization: adminProcedure

### tRPC Procedures (Catalog Routes - `/server/api/routers/catalog/glass-type.ts`)

**List (Public/Protected)**:
- Input: None (all active types returned)
- Output: All active GlassType records (both seeded and custom) with characteristics/solutions
- Authorization: protectedProcedure (seller/user read-only)
- Performance: Cached in-memory (30 records), <500ms

**Detail (Public/Protected)**:
- Input: Glass type ID
- Output: Single GlassType with all specifications
- Authorization: protectedProcedure

### Seed Data Files

**glass-types.json** (30 Tecnoglass types)
```json
[
  {
    "code": "N70/38",
    "name": "Neutral Low-E",
    "series": "SERIE_N",
    "visibleTransmission": 72.7,
    "solarTransmission": 38.5,
    "exteriorReflectance": 12.1,
    "interiorReflectance": 10.8,
    "uValueWinter": 0.24,
    "uValueSummer": 0.26,
    "shgc": 0.42,
    "lsg": 1.73,
    "treatments": ["low-e"],
    "substrateTypes": ["clear"],
    "isSeeded": true,
    "isActive": true
  },
  ...
]
```

**glass-characteristics.json** (~10-15 records)
```json
[
  {
    "code": "TEMPERED",
    "name": "Templado",
    "description": "Tratamiento térmico que aumenta resistencia",
    "category": "TREATMENT"
  },
  ...
]
```

**glass-type-solutions.json** (Many-to-many relationships)
```json
[
  {
    "glassTypeCode": "N70/38",
    "solutionCode": "SOLAR_CONTROL",
    "performanceRating": "VERY_GOOD"
  },
  ...
]
```

---

## Next Steps

### Phase 2: Implementation (TK-015-027 through TK-015-035)

Task breakdown will be generated by `/speckit.tasks` command after this plan is reviewed.

**Expected Phase 4 Tasks** (9 total):

1. **TK-015-027**: Schema migration - remove deprecated fields, add GlassCharacteristic + GlassTypeSolution models
2. **TK-015-028**: Seed data files - glass-types.json (30 Tecnoglass) + characteristics + solutions
3. **TK-015-029**: Create glass-type.factory.ts with seed data generator
4. **TK-015-030**: Seed data migration script - populate GlassCharacteristic + GlassTypeSolution
5. **TK-015-031**: tRPC admin procedures - create/read/update/delete glass types (adminProcedure authorization)
6. **TK-015-032**: tRPC catalog procedures - read-only list/detail (protectedProcedure)
7. **TK-015-033**: Admin UI components - glass-types-table, glass-type-form, glass-type-dialog
8. **TK-015-034**: Unit + integration tests - seed validation, RBAC checks, migration tests
9. **TK-015-035**: E2E tests - admin CRUD flows, RBAC verification, catalog browsing

**Success Criteria**:
- ✅ Schema migration passes dry-run test
- ✅ 30 Tecnoglass types seeded with technical specs
- ✅ Admin can create/update/delete custom glass types
- ✅ Non-admin users get 403 Forbidden on admin endpoints
- ✅ Catalog loads all active types (<500ms)
- ✅ Glass type nomenclature displays in quote forms
- ✅ All E2E tests pass (admin CRUD, RBAC, catalog browsing)


```---

## Status & Sign-Off

**Plan Status**: ✅ COMPLETE - Ready for Phase 2 Implementation

**Created By**: SpecKit Planning Workflow  
**Date**: 2025-10-22  
**Reviewed By**: [TBD - awaiting team review]

**Next Step**: Run `/speckit.tasks` to generate Phase 2 task breakdown (TK-015-027 through TK-015-035)

