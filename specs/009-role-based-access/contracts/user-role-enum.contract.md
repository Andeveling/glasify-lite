# Contract: User Role Enum

**Type**: Database Schema Contract  
**Feature**: 009-role-based-access  
**Date**: 14 de octubre de 2025  
**Version**: 1.0.0

---

## Overview

This contract defines the `UserRole` enum type and its integration with the `User` model in the Prisma schema.

---

## Enum Definition

```prisma
/// User role in the system
/// - admin: Full access (models, all quotes, tenant config)
/// - seller: Limited access (own quotes, catalog)
/// - user: Client access (own quotes, catalog browsing)
enum UserRole {
  admin
  seller
  user
}
```

---

## TypeScript Type

```typescript
// Auto-generated by Prisma Client
export type UserRole = 'admin' | 'seller' | 'user';
```

---

## Database SQL Type

```sql
CREATE TYPE "UserRole" AS ENUM ('admin', 'seller', 'user');
```

---

## Zod Validation Schema

```typescript
import { z } from 'zod';

export const userRoleSchema = z.enum(['admin', 'seller', 'user'], {
  errorMap: () => ({ 
    message: 'Rol debe ser uno de: admin, seller, user' 
  }),
});

// Type inference
export type UserRoleInput = z.infer<typeof userRoleSchema>;
```

---

## Usage in User Model

```prisma
model User {
  id                String                  @id @default(cuid())
  name              String?
  email             String?                 @unique
  emailVerified     DateTime?
  image             String?
  role              UserRole                @default(user)  // NEW
  // ... other fields
  
  @@index([role])  // Performance index
}
```

---

## Valid Values

| Value    | Description                       | System Access                         |
| -------- | --------------------------------- | ------------------------------------- |
| `admin`  | System administrator              | Full access to all features and data  |
| `seller` | Sales representative / Commercial | Own quotes, catalog, no system config |
| `user`   | End client (default)              | Own quotes, catalog browsing          |

---

## Default Value

**Default**: `user`

**Rationale**: 
- Safe default for new users (minimum privileges)
- Backward compatible (existing users without role become clients)
- Prevents accidental privilege escalation

---

## Migration Impact

### Forward Migration

```sql
CREATE TYPE "UserRole" AS ENUM ('admin', 'seller', 'user');

ALTER TABLE "User" 
ADD COLUMN "role" "UserRole" NOT NULL DEFAULT 'user';

CREATE INDEX "User_role_idx" ON "User"("role");
```

### Rollback Migration

```sql
DROP INDEX IF EXISTS "User_role_idx";
ALTER TABLE "User" DROP COLUMN IF EXISTS "role";
DROP TYPE IF EXISTS "UserRole";
```

---

## Validation Rules

### Database Level
- âœ… Values constrained to enum members only (PostgreSQL enforces)
- âœ… NOT NULL constraint (default value ensures this)

### Application Level
- âœ… Zod schema validates input in tRPC procedures
- âœ… TypeScript type safety prevents invalid values at compile time

---

## Backward Compatibility

### ADMIN_EMAIL Fallback

For backward compatibility, the system supports both:

1. **Database role** (primary): `User.role` field
2. **Environment variable** (fallback): `ADMIN_EMAIL` check

**Session Callback Logic**:

```typescript
callbacks: {
  session: ({ session, user }) => {
    const isAdminEmail = user.email?.toLowerCase() === env.ADMIN_EMAIL?.toLowerCase();
    const role = user.role || (isAdminEmail ? 'admin' : 'user');
    
    return {
      ...session,
      user: {
        ...session.user,
        id: user.id,
        role: role,
      },
    };
  },
}
```

**Precedence**: Database `role` field takes priority over `ADMIN_EMAIL` check.

---

## Breaking Changes

### None (Additive Change)

This is an **additive** change:
- âœ… New column with safe default (`user`)
- âœ… Existing code not affected (all users default to `user` role)
- âœ… No data loss or corruption risk

### Future Breaking Change (v2.0)

If `ADMIN_EMAIL` fallback is removed in the future:
- âš ï¸ **Breaking**: Systems relying solely on `ADMIN_EMAIL` must migrate to DB roles
- ðŸ“ **Migration Guide**: Run data migration to set `role = 'admin'` for admin email users

---

## Testing Contract

### Unit Tests

```typescript
// tests/unit/user-role-validation.test.ts
import { describe, expect, it } from 'vitest';
import { userRoleSchema } from '@/server/api/routers/user';

describe('UserRole Validation', () => {
  it('accepts valid admin role', () => {
    expect(userRoleSchema.parse('admin')).toBe('admin');
  });

  it('accepts valid seller role', () => {
    expect(userRoleSchema.parse('seller')).toBe('seller');
  });

  it('accepts valid user role', () => {
    expect(userRoleSchema.parse('user')).toBe('user');
  });

  it('rejects invalid role', () => {
    expect(() => userRoleSchema.parse('superadmin')).toThrow();
  });

  it('rejects null', () => {
    expect(() => userRoleSchema.parse(null)).toThrow();
  });
});
```

### Integration Tests

```typescript
// tests/integration/user-role-migration.test.ts
import { describe, expect, it, beforeAll } from 'vitest';
import { db } from '@/server/db';

describe('User Role Migration', () => {
  it('new users default to user role', async () => {
    const user = await db.user.create({
      data: {
        email: 'newuser@test.com',
        name: 'New User',
      },
    });

    expect(user.role).toBe('user');
  });

  it('can create user with admin role', async () => {
    const admin = await db.user.create({
      data: {
        email: 'admin@test.com',
        name: 'Admin User',
        role: 'admin',
      },
    });

    expect(admin.role).toBe('admin');
  });

  it('can update user role', async () => {
    const user = await db.user.create({
      data: { email: 'seller@test.com', name: 'Seller' },
    });

    const updated = await db.user.update({
      where: { id: user.id },
      data: { role: 'seller' },
    });

    expect(updated.role).toBe('seller');
  });
});
```

---

## Version History

| Version | Date       | Changes                 | Author      |
| ------- | ---------- | ----------------------- | ----------- |
| 1.0.0   | 2025-10-14 | Initial enum definition | AI Planning |

---

## Related Contracts

- [middleware-role-checks.contract.md](./middleware-role-checks.contract.md) - Middleware authorization
- [trpc-admin-procedures.contract.md](./trpc-admin-procedures.contract.md) - Admin procedure helpers

---

## Approval Status

- [ ] Database Schema Review
- [ ] Backend Team Review
- [ ] Security Team Review
- [ ] Migration Tested (forward + rollback)

---

## References

- [Prisma Enum Documentation](https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#defining-enums)
- [PostgreSQL ENUM Type](https://www.postgresql.org/docs/current/datatype-enum.html)
- [Zod Enum Validation](https://zod.dev/?id=enums)
