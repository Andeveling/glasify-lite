// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ModelStatus {
  draft
  published
}

enum ServiceType {
  area
  perimeter
  fixed
}

enum ServiceUnit {
  unit
  sqm
  ml
}

enum QuoteStatus {
  draft
  sent
  canceled
}

enum AdjustmentScope {
  item
  quote
}

enum AdjustmentSign {
  positive
  negative
}

enum GlassPurpose {
  general
  insulation
  security
  decorative
}

enum CostType {
  fixed
  per_mm_width
  per_mm_height
  per_sqm
}

// Necessary for Next auth
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? // @db.Text
  access_token             String? // @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? // @db.Text
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id             String              @id @default(cuid())
  name           String?
  email          String?             @unique
  emailVerified  DateTime?
  image          String?
  accounts       Account[]
  sessions       Session[]
  manufacturerId String?
  manufacturer   Manufacturer?       @relation(fields: [manufacturerId], references: [id], onDelete: SetNull)
  quotes         Quote[]
  priceChanges   ModelPriceHistory[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Manufacturer {
  id                String      @id @default(cuid())
  name              String
  currency          String      @db.Char(3)
  quoteValidityDays Int         @default(15)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  models            Model[]
  glassTypes        GlassType[]
  services          Service[]
  quotes            Quote[]
  users             User[]

  @@index([currency])
}

model Model {
  id                     String              @id @default(cuid())
  manufacturerId         String
  manufacturer           Manufacturer        @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  name                   String
  status                 ModelStatus         @default(draft)
  minWidthMm             Int
  maxWidthMm             Int
  minHeightMm            Int
  maxHeightMm            Int
  basePrice              Decimal             @db.Decimal(12, 2)
  costPerMmWidth         Decimal             @db.Decimal(12, 4)
  costPerMmHeight        Decimal             @db.Decimal(12, 4)
  accessoryPrice         Decimal?            @db.Decimal(12, 2)
  /// Descuento fijo por lado para el cálculo del vidrio facturable (mm)
  /// Fórmula: anchoEfectivo = widthMm - glassDiscountWidthMm; altoEfectivo = heightMm - glassDiscountHeightMm
  /// El área de vidrio facturable se calcula con los valores efectivos (en m²) y se multiplica por el pricePerSqm del GlassType.
  glassDiscountWidthMm   Int                 @default(0)
  glassDiscountHeightMm  Int                 @default(0)
  compatibleGlassTypeIds String[]
  /// Margen de ganancia en porcentaje (ej: 30 = 30%)
  profitMarginPercentage Decimal?            @db.Decimal(5, 2)
  /// Fecha de la última revisión de costos
  lastCostReviewDate     DateTime?
  /// Notas sobre la estructura de costos
  costNotes              String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  quoteItems             QuoteItem[]
  costBreakdown          ModelCostBreakdown[]
  priceHistory           ModelPriceHistory[]

  @@index([manufacturerId, status])
}

model GlassType {
  id             String       @id @default(cuid())
  manufacturerId String
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  name           String
  purpose        GlassPurpose
  thicknessMm    Int
  /// Precio por metro cuadrado del vidrio (moneda de Manufacturer)
  pricePerSqm    Decimal      @db.Decimal(12, 2)
  /// Transmitancia térmica (W/m²·K) — opcional si aplica
  uValue         Decimal?     @db.Decimal(5, 2)
  /// Atributos de seguridad/eficiencia
  isTempered     Boolean      @default(false)
  isLaminated    Boolean      @default(false)
  isLowE         Boolean      @default(false)
  isTripleGlazed Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  quoteItems     QuoteItem[]

  @@index([manufacturerId, purpose])
}

model Service {
  id             String             @id @default(cuid())
  manufacturerId String
  manufacturer   Manufacturer       @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  name           String
  type           ServiceType
  unit           ServiceUnit
  rate           Decimal            @db.Decimal(12, 4)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  quoteServices  QuoteItemService[]

  @@index([manufacturerId, type])
}

model Quote {
  id             String       @id @default(cuid())
  manufacturerId String
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  status         QuoteStatus  @default(draft)
  currency       String       @db.Char(3)
  total          Decimal      @default(0) @db.Decimal(12, 2)
  validUntil     DateTime?
  contactPhone   String?
  contactAddress String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  items          QuoteItem[]
  adjustments    Adjustment[]

  @@index([manufacturerId, status])
}

model QuoteItem {
  id               String             @id @default(cuid())
  quoteId          String
  quote            Quote              @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  modelId          String
  model            Model              @relation(fields: [modelId], references: [id], onDelete: Restrict)
  glassTypeId      String
  glassType        GlassType          @relation(fields: [glassTypeId], references: [id], onDelete: Restrict)
  widthMm          Int
  heightMm         Int
  accessoryApplied Boolean            @default(false)
  subtotal         Decimal            @db.Decimal(12, 2)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  services         QuoteItemService[]
  adjustments      Adjustment[]

  @@index([quoteId])
}

model QuoteItemService {
  id          String      @id @default(cuid())
  quoteItemId String
  quoteItem   QuoteItem   @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  serviceId   String
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  unit        ServiceUnit
  quantity    Decimal     @db.Decimal(12, 4)
  amount      Decimal     @db.Decimal(12, 2)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([quoteItemId, serviceId])
}

model Adjustment {
  id          String          @id @default(cuid())
  scope       AdjustmentScope
  concept     String
  unit        ServiceUnit
  value       Decimal         @db.Decimal(12, 4)
  sign        AdjustmentSign
  quoteId     String?
  quote       Quote?          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteItemId String?
  quoteItem   QuoteItem?      @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  amount      Decimal         @db.Decimal(12, 2)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([quoteId])
  @@index([quoteItemId])
}

/// Desglose de componentes de costo para cada modelo
/// Permite al admin definir y ajustar cada componente que conforma el precio final
model ModelCostBreakdown {
  id          String   @id @default(cuid())
  modelId     String
  model       Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  /// Nombre del componente: 'perfil_vertical', 'perfil_horizontal', 'esquineros', 'herrajes', 'mano_obra', etc.
  component   String
  /// Tipo de costo: fixed, per_mm_width, per_mm_height, per_sqm
  costType    CostType
  /// Costo unitario del componente (en la moneda del fabricante)
  unitCost    Decimal  @db.Decimal(12, 4)
  /// Notas adicionales sobre este componente
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([modelId])
  @@index([modelId, costType])
}

/// Historial de cambios de precio de los modelos
/// Permite rastrear cuándo y por qué cambiaron los precios
model ModelPriceHistory {
  id              String   @id @default(cuid())
  modelId         String
  model           Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  /// Precio base en el momento del cambio
  basePrice       Decimal  @db.Decimal(12, 2)
  /// Costo por mm de ancho en el momento del cambio
  costPerMmWidth  Decimal  @db.Decimal(12, 4)
  /// Costo por mm de alto en el momento del cambio
  costPerMmHeight Decimal  @db.Decimal(12, 4)
  /// Razón del cambio: 'aumento_material', 'ajuste_mercado', 'promocion', etc.
  reason          String?
  /// Fecha desde la cual este precio es efectivo
  effectiveFrom   DateTime
  /// Usuario que realizó el cambio
  createdBy       String?
  createdByUser   User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())

  @@index([modelId, effectiveFrom])
  @@index([createdBy])
}
