generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String    @map("providerAccountId")
  providerId            String    @map("provider")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  accessTokenExpiresAt  DateTime? @map("expires_at")
  idToken               String?   @map("id_token")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  userId                String
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime @map("expires")
  token     String   @unique @map("sessionToken")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String              @id @default(cuid())
  name          String?
  email         String?             @unique
  emailVerified Boolean             @default(false)
  image         String?
  role          UserRole            @default(user)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  accounts      Account[]
  priceChanges  ModelPriceHistory[]
  quotes        Quote[]
  sessions      Session[]

  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

model TenantConfig {
  id                 String          @id @default("1")
  /// Business/company name shown in quotes and invoices
  businessName       String
  /// ISO 4217 currency code (3 characters): COP, USD, EUR, etc.
  currency           String          @db.Char(3)
  /// Number of days a quote is valid before expiring
  quoteValidityDays  Int             @default(15)
  /// IETF BCP 47 locale (es-CO, en-US, es-MX, etc.) for date/number formatting
  locale             String          @default("es-CO")
  /// IANA timezone identifier (America/Bogota, America/New_York, etc.)
  timezone           String          @default("America/Bogota")
  /// Optional contact information
  contactEmail       String?
  contactPhone       String?
  businessAddress    String?
  /// Timestamps
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  /// Branding: Logo URL (path to uploaded file)
  logoUrl            String?
  /// Branding: Primary brand color (hex format: #RRGGBB)
  primaryColor       String          @default("#3B82F6")
  /// Branding: Secondary brand color (hex format: #RRGGBB)
  secondaryColor     String          @default("#1E40AF")
  /// Social Media: Facebook page URL
  facebookUrl        String?
  /// Social Media: Instagram profile URL
  instagramUrl       String?
  /// Social Media: LinkedIn company URL
  linkedinUrl        String?
  /// WhatsApp: Contact number in E.164 format (+[country][number])
  whatsappNumber     String?
  /// WhatsApp: Enable floating button in catalog and quotes
  whatsappEnabled    Boolean         @default(false)
  /// Fixed base cost for transportation (e.g., 50000 COP)
  transportBaseRate  Decimal?        @db.Decimal(10, 2)
  /// Cost per kilometer (e.g., 1000 COP per km)
  transportPerKmRate Decimal?        @db.Decimal(10, 2)
  /// Warehouse city name for display (e.g., "Buga")
  warehouseCity      String?         @db.VarChar(100)
  /// Warehouse location and transportation rates (Feature: 001-delivery-address)
  /// Warehouse latitude coordinate (WGS84, -90 to +90, 7 decimal places)
  warehouseLatitude  Decimal?        @db.Decimal(10, 7)
  /// Warehouse longitude coordinate (WGS84, -180 to +180, 7 decimal places)
  warehouseLongitude Decimal?        @db.Decimal(10, 7)
  glassSuppliers     GlassSupplier[]

  @@index([currency])
}

model ProfileSupplier {
  id           String       @id @default(cuid())
  /// Supplier name (Rehau, Deceuninck, Azembla, etc.)
  name         String       @unique
  /// Type of material the supplier provides
  materialType MaterialType
  /// Whether this supplier is active for selection
  isActive     Boolean      @default(true)
  /// Additional notes about the supplier
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  models       Model[]

  @@index([isActive])
  @@index([materialType])
}

model Manufacturer {
  id                String   @id @default(cuid())
  name              String
  currency          String   @db.Char(3)
  quoteValidityDays Int      @default(15)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([currency])
}

model Model {
  id                     String               @id @default(cuid())
  name                   String
  status                 ModelStatus          @default(draft)
  minWidthMm             Int
  maxWidthMm             Int
  minHeightMm            Int
  maxHeightMm            Int
  basePrice              Decimal              @db.Decimal(12, 4)
  costPerMmWidth         Decimal              @db.Decimal(12, 4)
  costPerMmHeight        Decimal              @db.Decimal(12, 4)
  accessoryPrice         Decimal?             @db.Decimal(12, 4)
  compatibleGlassTypeIds String[]
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  glassDiscountHeightMm  Int                  @default(0)
  /// Descuento fijo por lado para el cálculo del vidrio facturable (mm)
  /// Fórmula: anchoEfectivo = widthMm - glassDiscountWidthMm; altoEfectivo = heightMm - glassDiscountHeightMm
  /// El área de vidrio facturable se calcula con los valores efectivos (en m²) y se multiplica por el pricePerSqm del GlassType.
  glassDiscountWidthMm   Int                  @default(0)
  /// Notas sobre la estructura de costos
  costNotes              String?
  /// Fecha de la última revisión de costos
  lastCostReviewDate     DateTime?
  /// Margen de ganancia en porcentaje (ej: 30 = 30%)
  profitMarginPercentage Decimal?             @db.Decimal(5, 2)
  profileSupplierId      String?
  imageUrl               String?              @default("")
  profileSupplier        ProfileSupplier?     @relation(fields: [profileSupplierId], references: [id])
  modelColors            ModelColor[]
  costBreakdown          ModelCostBreakdown[]
  priceHistory           ModelPriceHistory[]
  quoteItems             QuoteItem[]

  @@index([profileSupplierId, status])
  @@index([name])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([updatedAt(sort: Desc)])
}

model GlassType {
  id                String                    @id @default(cuid())
  name              String                    @unique
  thicknessMm       Int
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  /// Transmitancia térmica (W/m²·K) — opcional si aplica
  uValue            Decimal?                  @db.Decimal(5, 2)
  /// Detailed description of the glass type
  description       String?
  /// Whether this glass type is active for selection
  isActive          Boolean                   @default(true)
  /// Date of last technical review
  lastReviewDate    DateTime?
  /// Light transmission percentage — 0.00 to 1.00
  lightTransmission Decimal?                  @db.Decimal(4, 2)
  /// Solar factor (g-value) — 0.00 to 1.00
  solarFactor       Decimal?                  @db.Decimal(4, 2)
  /// Manufacturer product code (e.g., "N70/38", "ClimaGuard 80/70")
  code              String                    @unique
  /// Flag for seed-generated types (true) vs tenant-created custom types (false)
  isSeeded          Boolean                   @default(false)
  /// Manufacturer name (e.g., "Tecnoglass", "Guardian", "Vitro")
  manufacturer      String?
  /// Seed data version (e.g., "1.0", "1.1") for idempotent updates
  seedVersion       String?
  /// Product line grouping (e.g., "Serie-N", "Serie-R", "ClimaGuard")
  series            String?
  /// Price per square meter for this glass type
  pricePerSqm       Decimal                   @db.Decimal(12, 4)
  characteristics   GlassTypeCharacteristic[]
  solutions         GlassTypeSolution[]
  quoteItems        QuoteItem[]

  @@index([name])
  @@index([code])
  @@index([series])
  @@index([manufacturer])
  @@index([isActive])
  @@index([isSeeded])
  @@index([thicknessMm])
  @@index([pricePerSqm])
  @@index([createdAt(sort: Desc)])
  @@index([updatedAt(sort: Desc)])
}

model Service {
  id                 String             @id @default(cuid())
  name               String
  type               ServiceType
  unit               ServiceUnit
  rate               Decimal            @db.Decimal(12, 4)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  isActive           Boolean            @default(true)
  /// Unidad mínima de cobro (aplica solo a servicios tipo area/perimeter)
  /// Ejemplo: Si minimumBillingUnit = 1.0 y el área calculada es 0.25m², se cobra 1.0m²
  /// NULL significa que no hay mínimo (se cobra la cantidad calculada)
  minimumBillingUnit Decimal?           @db.Decimal(10, 4)
  quoteServices      QuoteItemService[]

  @@index([isActive])
}

model Quote {
  id                String          @id @default(cuid())
  userId            String?
  status            QuoteStatus     @default(draft)
  currency          String          @db.Char(3)
  total             Decimal         @default(0) @db.Decimal(12, 4)
  validUntil        DateTime?
  contactPhone      String?
  /// @deprecated Use structured project fields instead. Will be removed in v2.0.
  contactAddress    String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  /// @deprecated Use ProjectAddress relationship instead. Maintained for backward compatibility.
  projectCity       String?         @db.VarChar(100)
  projectName       String?         @db.VarChar(100)
  /// @deprecated Use ProjectAddress relationship instead. Maintained for backward compatibility.
  projectPostalCode String?         @db.VarChar(20)
  /// @deprecated Use ProjectAddress relationship instead. Maintained for backward compatibility.
  projectState      String?         @db.VarChar(100)
  /// @deprecated Use ProjectAddress relationship instead. Maintained for backward compatibility.
  projectStreet     String?         @db.VarChar(200)
  sentAt            DateTime?
  adjustments       Adjustment[]
  projectAddress    ProjectAddress?
  user              User?           @relation(fields: [userId], references: [id])
  items             QuoteItem[]

  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, validUntil])
  @@index([projectName])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model QuoteItem {
  id                       String             @id @default(cuid())
  quoteId                  String
  modelId                  String
  glassTypeId              String
  widthMm                  Int
  heightMm                 Int
  accessoryApplied         Boolean            @default(false)
  subtotal                 Decimal            @db.Decimal(12, 4)
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  name                     String             @db.VarChar(50)
  quantity                 Int                @default(1)
  colorHexCode             String?            @db.VarChar(7)
  colorId                  String?
  colorName                String?            @db.VarChar(50)
  colorSurchargePercentage Decimal?           @db.Decimal(5, 2)
  roomLocation             String?            @db.VarChar(100)
  adjustments              Adjustment[]
  color                    Color?             @relation(fields: [colorId], references: [id], onDelete: Restrict)
  glassType                GlassType          @relation(fields: [glassTypeId], references: [id])
  model                    Model              @relation(fields: [modelId], references: [id])
  quote                    Quote              @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  services                 QuoteItemService[]

  @@index([quoteId])
  @@index([colorId])
}

model QuoteItemService {
  id          String      @id @default(cuid())
  quoteItemId String
  serviceId   String
  unit        ServiceUnit
  quantity    Decimal     @db.Decimal(12, 4)
  amount      Decimal     @db.Decimal(12, 4)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  quoteItem   QuoteItem   @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([quoteItemId, serviceId])
}

model Adjustment {
  id          String          @id @default(cuid())
  scope       AdjustmentScope
  concept     String
  unit        ServiceUnit
  value       Decimal         @db.Decimal(12, 4)
  sign        AdjustmentSign
  quoteId     String?
  quoteItemId String?
  amount      Decimal         @db.Decimal(12, 4)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  quote       Quote?          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteItem   QuoteItem?      @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([quoteItemId])
}

model ModelCostBreakdown {
  id        String   @id @default(cuid())
  modelId   String
  /// Nombre del componente: 'perfil_vertical', 'perfil_horizontal', 'esquineros', 'herrajes', 'mano_obra', etc.
  component String
  /// Tipo de costo: fixed, per_mm_width, per_mm_height, per_sqm
  costType  CostType
  /// Costo unitario del componente (en la moneda del fabricante)
  unitCost  Decimal  @db.Decimal(12, 4)
  /// Notas adicionales sobre este componente
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  model     Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId])
  @@index([modelId, costType])
}

model ModelPriceHistory {
  id              String   @id @default(cuid())
  modelId         String
  /// Precio base en el momento del cambio
  basePrice       Decimal  @db.Decimal(12, 4)
  /// Costo por mm de ancho en el momento del cambio
  costPerMmWidth  Decimal  @db.Decimal(12, 4)
  /// Costo por mm de alto en el momento del cambio
  costPerMmHeight Decimal  @db.Decimal(12, 4)
  /// Razón del cambio: 'aumento_material', 'ajuste_mercado', 'promocion', etc.
  reason          String?
  /// Fecha desde la cual este precio es efectivo
  effectiveFrom   DateTime
  /// Usuario que realizó el cambio
  createdBy       String?
  createdAt       DateTime @default(now())
  createdByUser   User?    @relation(fields: [createdBy], references: [id])
  model           Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId, effectiveFrom])
  @@index([createdBy])
}

model GlassSolution {
  id          String              @id @default(cuid())
  /// Clave única para identificar la solución (ej: 'security', 'thermal_insulation')
  key         String              @unique
  /// Nombre técnico en inglés
  name        String
  /// Nombre comercial en español
  nameEs      String
  /// Descripción de la solución
  description String?
  /// Icono de Lucide React (ej: 'Shield', 'Snowflake')
  icon        String?
  /// Orden de visualización (menor = más arriba)
  sortOrder   Int                 @default(0)
  /// Si la solución está activa para mostrarse a usuarios
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  /// Flag for seed-generated solutions (true) vs custom solutions (false)
  isSeeded    Boolean             @default(false)
  /// Seed data version (e.g., "1.0", "1.1") for idempotent updates
  seedVersion String?
  /// URL-friendly slug para rutas dinámicas (ej: 'solar-control', 'energy-efficiency')
  /// Derivado de `key` reemplazando guiones bajos con guiones (kebab-case)
  slug        String              @unique @db.VarChar(100)
  glassTypes  GlassTypeSolution[]

  @@index([sortOrder])
  @@index([isActive])
  @@index([isSeeded])
  @@index([slug])
}

model GlassTypeSolution {
  id                String            @id @default(cuid())
  glassTypeId       String
  solutionId        String
  /// Calificación de rendimiento para esta solución (1-5)
  performanceRating PerformanceRating
  /// Indica si esta es la solución principal del vidrio
  isPrimary         Boolean           @default(false)
  /// Notas adicionales sobre esta clasificación
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  glassType         GlassType         @relation(fields: [glassTypeId], references: [id], onDelete: Cascade)
  solution          GlassSolution     @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([glassTypeId, solutionId])
  @@index([glassTypeId])
  @@index([solutionId])
  @@index([isPrimary])
}

model GlassSupplier {
  id             String        @id @default(cuid())
  /// Supplier name (Guardian, Saint-Gobain, Pilkington, etc.)
  name           String        @unique
  /// Short code for the supplier (e.g., 'GRD' for Guardian)
  code           String?       @unique
  /// Country where the supplier is based
  country        String?
  /// Official website URL
  website        String?
  /// Contact email for orders/inquiries
  contactEmail   String?
  /// Contact phone number
  contactPhone   String?
  /// Whether this supplier is active for selection
  isActive       Boolean       @default(true)
  /// Additional notes about the supplier
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  /// Optional tenant config ID for multi-tenancy support (currently unused in single-tenant mode)
  tenantConfigId String?       @default("1")
  tenantConfig   TenantConfig? @relation(fields: [tenantConfigId], references: [id])

  @@index([isActive])
  @@index([code])
  @@index([tenantConfigId])
}

model GlassCharacteristic {
  id          String                    @id @default(cuid())
  /// Unique key for the characteristic (e.g., 'tempered', 'laminated', 'low_e')
  key         String                    @unique
  /// Technical name in English
  name        String
  /// Commercial name in Spanish
  nameEs      String
  /// Description of the characteristic
  description String?
  /// Category grouping (e.g., 'safety', 'thermal', 'acoustic', 'coating')
  category    String
  /// Whether this characteristic is active for assignment
  isActive    Boolean                   @default(true)
  /// Display order (lower = higher priority)
  sortOrder   Int                       @default(0)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  /// Flag for seed-generated characteristics (true) vs custom characteristics (false)
  isSeeded    Boolean                   @default(false)
  /// Seed data version (e.g., "1.0", "1.1") for idempotent updates
  seedVersion String?
  glassTypes  GlassTypeCharacteristic[]

  @@index([category])
  @@index([isActive])
  @@index([isSeeded])
}

model GlassTypeCharacteristic {
  id               String              @id @default(cuid())
  glassTypeId      String
  characteristicId String
  /// Optional value for the characteristic (e.g., '6.38mm' for laminated thickness)
  value            String?
  /// Optional certification reference (e.g., 'EN 12150' for tempered glass)
  certification    String?
  /// Additional notes about this characteristic application
  notes            String?
  createdAt        DateTime            @default(now())
  characteristic   GlassCharacteristic @relation(fields: [characteristicId], references: [id], onDelete: Cascade)
  glassType        GlassType           @relation(fields: [glassTypeId], references: [id], onDelete: Cascade)

  @@unique([glassTypeId, characteristicId])
  @@index([glassTypeId])
  @@index([characteristicId])
}

model Color {
  id          String       @id @default(cuid())
  /// Commercial color name (e.g., "Blanco", "Nogal Europeo")
  name        String       @db.VarChar(50)
  /// Industry standard RAL code (optional, e.g., "RAL 9010")
  ralCode     String?      @db.VarChar(10)
  /// Hexadecimal color code for UI rendering (#RRGGBB format)
  hexCode     String       @db.VarChar(7)
  /// Soft delete flag (false = hidden in new assignments, but preserved in existing)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  modelColors ModelColor[]
  quoteItems  QuoteItem[]

  @@unique([name, hexCode])
  @@index([isActive])
  @@index([name])
}

model ModelColor {
  id                  String   @id @default(cuid())
  modelId             String
  colorId             String
  /// Percentage surcharge added to model base price (0.00-100.00)
  surchargePercentage Decimal  @db.Decimal(5, 2)
  /// One color per model must be default (auto-selected if client doesn't choose)
  isDefault           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  color               Color    @relation(fields: [colorId], references: [id])
  model               Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, colorId])
  @@index([modelId, isDefault])
  @@index([colorId])
}

model ProjectAddress {
  id         String   @id @default(cuid())
  /// Foreign key to Quote (optional for backward compatibility)
  quoteId    String?  @unique
  /// User-defined label (e.g., "Obra Principal", "Bodega Cliente")
  label      String?  @db.VarChar(100)
  /// Country name (e.g., "Colombia")
  country    String?  @db.VarChar(100)
  /// Department/State (e.g., "Antioquia")
  region     String?  @db.VarChar(100)
  /// City/Municipality (e.g., "Medellín")
  city       String?  @db.VarChar(100)
  /// Neighborhood/District (e.g., "Barrio Granada")
  district   String?  @db.VarChar(100)
  /// Street address (e.g., "Calle 45 #23-10")
  street     String?  @db.VarChar(200)
  /// Landmark/reference (e.g., "Frente a finca Los Arrayanes")
  reference  String?  @db.VarChar(200)
  /// Latitude coordinate (WGS84, -90 to +90, 7 decimal places)
  latitude   Decimal? @db.Decimal(10, 7)
  /// Longitude coordinate (WGS84, -180 to +180, 7 decimal places)
  longitude  Decimal? @db.Decimal(10, 7)
  /// Postal/ZIP code (optional for LATAM rural areas)
  postalCode String?  @db.VarChar(20)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  quote      Quote?   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([city])
  @@index([latitude, longitude])
}

enum ModelStatus {
  draft
  published
}

enum ServiceType {
  area
  perimeter
  fixed
}

enum ServiceUnit {
  unit
  sqm
  ml
}

enum QuoteStatus {
  draft
  sent
  canceled
}

enum AdjustmentScope {
  item
  quote
}

enum AdjustmentSign {
  positive
  negative
}

enum GlassPurpose {
  general
  insulation
  security
  decorative
}

enum PerformanceRating {
  basic
  standard
  good
  very_good
  excellent
}

enum CostType {
  fixed
  per_mm_width
  per_mm_height
  per_sqm
}

enum MaterialType {
  PVC
  ALUMINUM
  WOOD
  MIXED
}

enum UserRole {
  admin
  seller
  user
}
